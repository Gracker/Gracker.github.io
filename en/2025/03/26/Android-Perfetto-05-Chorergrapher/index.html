<!DOCTYPE html>
<html lang="en">
    <!-- title -->
            <!-- keywords -->

                  <head>
                    <meta charset="utf-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
                    <meta name="author" content="Gracker">
                    <meta name="renderer" content="webkit">
                    <meta name="copyright" content="Gracker">
                      <meta name="keywords" content="Android,Performance,AndroidPerformance,性能,优化,性能优化,Perf,Flutter,Linux,LinuxPerformance,AndroidFramework,Framework,Android Performance,Flutter,Kotlin,Memory,内存,流畅性,卡顿,响应速度,Jank,Smooth,Android Framework,ANR,Crash,Dalvik,ART,Jetpack,Compose,Optimization,Startup,Perfetto,Systrace,RenderThread,Java,Responsiveness,Smoothness">
                          <meta name="description" content="Technical blog about Android system performance optimization">
                          <meta name="description" content="This article introduces Choreographer, a class that App developers may not frequently encounter but is critically important in the Android Framework rendering pipeline. We will cover the background of">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Perfetto Series 5: Choreographer-based Rendering Flow">
<meta property="og:url" content="https://androidperformance.com/en/2025/03/26/Android-Perfetto-05-Chorergrapher/index.html">
<meta property="og:site_name" content="Android Performance">
<meta property="og:description" content="This article introduces Choreographer, a class that App developers may not frequently encounter but is critically important in the Android Framework rendering pipeline. We will cover the background of">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://androidperformance.com/en/images/15717420275540.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/Android-Perfetto-05-Chorergrapher/image-20250331235337987.png">
<meta property="og:image" content="https://androidperformance.com/en/images/15717420453069.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/15717420572997.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/15722752299458.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/Android-Perfetto-05-Chorergrapher/image-20250401001138400.png">
<meta property="og:image" content="https://androidperformance.com/en/images/Android-Perfetto-05-Chorergrapher/image-20250401002047386.png">
<meta property="og:image" content="https://androidperformance.com/en/images/15717420948412.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/15717421215251.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/15717421837064.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/15717421963577.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/15717422041938.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/15717422180571.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/15724225347501.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/15717422327935.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/15717422623134.jpg">
<meta property="og:image" content="https://androidperformance.com/en/images/WechatIMG581.png">
<meta property="article:published_time" content="2025-03-26T10:55:11.000Z">
<meta property="article:modified_time" content="2026-01-11T12:56:53.313Z">
<meta property="article:author" content="Gracker">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Jank">
<meta property="article:tag" content="Perfetto">
<meta property="article:tag" content="Systrace">
<meta property="article:tag" content="RenderThread">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://androidperformance.com/en/images/15717420275540.jpg">
                            <meta http-equiv="Cache-control" content="no-cache">
                            <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
                            <link rel="icon" href="/en/assets/favicon.ico">
                                <title>
                                  Android Perfetto Series 5: Choreographer-based Rendering Flow · Android Performance
                                </title>
                                <link rel="canonical" href="https://androidperformance.com/en/2025/03/26/Android-Perfetto-05-Chorergrapher/">
                                <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

                                  <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/en/font/Oswald-Regular.woff2") format('woff2'),
             url("/en/font/Oswald-Regular.ttf") format('truetype');
        font-display: swap;
    }

    body {
        margin: 0;
    }

    /* Removed initial hide to show content immediately */

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(
            -45deg,
            #444 0,
            #444 80px,
            #333 80px,
            #333 160px
        );
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

                                    <link id="stylesheet-base" rel="stylesheet" href="/en/%20css/style.css">
                                    <link id="stylesheet-mobile" rel="stylesheet" href="/en/%20css/mobile.css" media="screen and (max-width: 960px)">
                                    <link id="stylesheet-theme-dark" rel="stylesheet" href="/en/%20css/dark.css">
                                    <!-- Font Awesome CSS (with CDN fallback) -->
                                    <link id="stylesheet-fontawesome" rel="stylesheet"
                                      href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.4/css/all.min.css">
                                    <script>
                                      // Fallback for Font Awesome if CDN fails
                                      var faLink = document.getElementById('stylesheet-fontawesome');
                                      faLink.onerror = function () {
                                        var newLink = document.createElement('link');
                                        newLink.rel = 'stylesheet';
                                        newLink.href = 'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css';
                                        document.head.appendChild(newLink);
                                      };
                                    </script>
                                    <link rel="preconnect" href="https://cdn.bootcdn.net" crossorigin>
                                    <link rel="dns-prefetch" href="//cdn.bootcdn.net">
                                    <link rel="preconnect" href="https://cdn.staticfile.org" crossorigin>
                                    <link rel="dns-prefetch" href="//cdn.staticfile.org">
                                    <link rel="preload"
                                      href="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js" as="script">
                                    <link rel="preload" href="/en/scripts/main.js" as="script">
                                    <!-- use compressed font format to reduce transfer size -->
                                    <link rel="preload" href="/en/font/Source%5C%20Sans%5C%20Pro.woff2"
                                      as="font" type="font/woff2" crossorigin>
                                    <link rel="preload" href="/en/font/Source%5C%20Sans%5C%20Pro.woff" as="font"
                                      type="font/woff" crossorigin>
                                    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff"
                                      as="font" crossorigin>
                                    <!-- algolia -->
                                        <!-- 百度统计（延迟加载，失败静默）  -->
                                            <!-- CNZZ（延迟加载，失败静默）  -->
                                                <!-- Google tag (gtag.js) 延迟加载，失败静默 -->
                                                  <script>
                                                    (function () {
                                                      function loadGtag() {
                                                        try {
                                                          window.dataLayer = window.dataLayer || []
                                                          function gtag() { dataLayer.push(arguments) }
                                                          window.gtag = gtag
                                                          gtag('js', new Date())
                                                          var s = document.createElement('script')
                                                          s.async = true
                                                          s.src = 'https://www.googletagmanager.com/gtag/js?id=UA-50993302-2'
                                                          s.onerror = function () { }
                                                          s.onload = function () { gtag('config', 'UA-50993302-2') }
                                                          document.head.appendChild(s)
                                                        } catch (e) { }
                                                      }
                                                      if (window.requestIdleCallback) {
                                                        requestIdleCallback(loadGtag, { timeout: 5000 })
                                                      } else {
                                                        window.addEventListener('load', function () { setTimeout(loadGtag, 3000) })
                                                      }
                                                    })();
                                                  </script>
                                                    <!-- Hreflang Tags -->
                                                    
                                                      <link rel="alternate" hreflang="zh-CN" href="https://androidperformance.com/2025/03/26/Android-Perfetto-05-Chorergrapher/" />
                                                      <link rel="alternate" hreflang="en" href="https://androidperformance.com/en/2025/03/26/Android-Perfetto-05-Chorergrapher/" />
                                                      <link rel="alternate" hreflang="x-default" href="https://androidperformance.com/en/2025/03/26/Android-Perfetto-05-Chorergrapher/" />
                  <meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/en/atom.xml" title="Android Performance" type="application/atom+xml">
</head>
        <body class="post-body">
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        <div
            class="header-sidebar-menu">
                    <div style="padding-left: 1px;">&#xe775;</div>
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- language transition button -->
        <span class="header-lang-btn header-element">
            <a href="javascript:void(0)" onclick="toggleLanguage()" style="color: inherit; text-decoration: none;">
                <i class="fas fa-globe"></i>
            </a>
            <script>
                function toggleLanguage() {
                    var path = window.location.pathname;
                    console.log('Current path:', path);
                    // Check if path starts with /en/ or is exactly /en
                    var isEn = /^\/en(\/|$)/.test(path);

                    if (isEn) {
                        // Switch to CN: remove /en prefix
                        // If path is /en or /en/, it becomes /
                        // If path is /en/foo, it becomes /foo
                        var newPath = path.replace(/^\/en(\/|$)/, '/');
                        // Ensure we don't end up with empty string if something weird happens, though / covers it
                        if (newPath === '') newPath = '/';
                        // Clean up double slashes if any (except root /)
                        if (newPath !== '/' && newPath.endsWith('/')) newPath = newPath.slice(0, -1) + '/';
                        console.log('Switching to CN:', newPath);
                        window.location.href = newPath;
                    } else {
                        // Switch to EN: add /en prefix
                        // Handle root / specially to avoid /en//
                        var suffix = path;
                        if (suffix === '/') suffix = '';
                        console.log('Switching to EN:', '/en' + suffix);
                        window.location.href = '/en' + suffix;
                    }
                }
            </script>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href="/en/">Android Performance</a>
        </span>
    </div>
    <!-- toggle banner -->
                <div class="banner">
                        <div class="blog-title header-element">
                            <a href="/en/">
                                Android Performance
                            </a>
                        </div>
                        <div class="post-title header-element">
                            <a href="#" class="post-name">Android Perfetto Series 5: Choreographer-based Rendering Flow</a>
                        </div>
                </div>
</header>
        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- donate button -->
    <div class="donate-popup donate-popup--hidden">
    <div class="donate-popup__title">Buy Me A Coffee</div>
    <div class="donate-popup__content">
        <div class="donate-popup__content-description">If you find this article helpful, consider buying me a coffee.</div>
        <img
            class="donate-popup__content-qrCode"
            title="Wechat"
            alt="Wechat"
            src="/en/assets/donate-wechat.png"
        ></img>
        <img
            class="donate-popup__content-qrCode"
            title="Alipay"
            alt="Alipay"
            src="/en/assets/donate-alipay.png"
        ></img>
    </div>
</div>

    <div
        title="Donate to the author"
        class="footer-fixed-btn footer-fixed-btn--hidden donate-btn"
    >
        <i class="fas fa-donate"></i>
    </div>

    <!-- back to top button -->
    <div class="footer-fixed-btn footer-fixed-btn--hidden back-top">
        <div>&#xe639;</div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="    height:50vh;
">
    <!-- 主页  -->
    <!-- 404页  -->
    <div class="site-intro-placeholder"></div>
    <picture>
            <source type="image/webp" srcset="/en/intro/post-bg.webp">
        <img class="site-intro-img"
             src="/en/intro/post-bg.jpg"
             alt=""
loading="lazy"             decoding="async"
             fetchpriority="auto"
             sizes="100vw">
    </picture>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
                Android Perfetto Series 5: Choreographer-based Rendering Flow
            <!-- 404 -->
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            <!-- 404 -->
        </p>
        <!-- 文章页 meta -->
            <div class="post-intros">
                <!-- 文章页标签  -->
                    <div class="post-intro-tags" >
        <span class="post-category" data-categories="Android">
            <i class="fas fa-folder post-category-icon"></i>
            <span class="post-category-text">
                Android
            </span>
        </span>
        <a class="post-tag" href="javascript:void(0);" data-tags="Android">Android</a>
        <a class="post-tag" href="javascript:void(0);" data-tags="Jank">Jank</a>
        <a class="post-tag" href="javascript:void(0);" data-tags="Perfetto">Perfetto</a>
        <a class="post-tag" href="javascript:void(0);" data-tags="Systrace">Systrace</a>
        <a class="post-tag" href="javascript:void(0);" data-tags="RenderThread">RenderThread</a>
</div>

                <!-- 文章字数统计 -->
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count word-count">6.7k</span>Reading time: <span class="post-count reading-time">42 min</span></span>
                    </div>
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2025/03/26</span>
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
    </div>
</div>

            
            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.bootcdn.net/ajax/libs/webfont/1.6.28/webfontloader.min.js',
      'https://cdn.staticfile.org/webfont/1.6.28/webfontloader.min.js',
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      "/en/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/en/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" alt="loading">
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <p>This article introduces <strong>Choreographer</strong>, a class that App developers may not frequently encounter but is critically important in the Android Framework rendering pipeline. We will cover the background of its introduction, a brief overview, partial source code analysis, its interaction with MessageQueue, its application in APM (Application Performance Monitoring), and some optimization ideas for Choreographer by mobile phone manufacturers.</p>
<p>The introduction of Choreographer is mainly to cooperate with Vsync to provide a stable Message processing timing for upper-layer application rendering. When the Vsync signal arrives, the system controls the timing of each frame’s drawing operation by adjusting the Vsync signal cycle. Currently, the screen refresh rate of mainstream mobile phones has reached 120Hz, which means refreshing once every 8.3ms. The system adjusts the Vsync cycle accordingly to match the screen refresh frequency. When each Vsync cycle arrives, the Vsync signal wakes up the Choreographer to execute the application’s drawing operation. This is the main purpose of introducing Choreographer. Understanding Choreographer can also help application developers deeply understand the operating principle of each frame, and at the same time deepen their understanding of core components such as <strong>Message</strong>, <strong>Handler</strong>, <strong>Looper</strong>, <strong>MessageQueue</strong>, <strong>Input</strong>, <strong>Animation</strong>, <strong>Measure</strong>, <strong>Layout</strong>, and <strong>Draw</strong>. Many <strong>APM</strong> (Application Performance Monitoring) tools also utilize the combination mechanisms of <strong>Choreographer</strong> (via FrameCallback + FrameInfo), <strong>MessageQueue</strong> (via IdleHandler), and <strong>Looper</strong> (via custom MessageLogging) for performance monitoring. After deeply understanding these mechanisms, developers can conduct performance optimization more specifically and form systematic optimization ideas.</p>
<span id="more"></span>

<h2 id="Table-of-Contents"><a href="#Table-of-Contents" class="headerlink" title="Table of Contents"></a>Table of Contents</h2><ul>
<li><a href="#series">Perfetto Series Catalog</a></li>
<li><a href="#main-thread-essence">The Essence of Main Thread Execution</a></li>
<li><a href="#choreographer-intro">Introduction to Choreographer</a></li>
<li><a href="#source">Source Code Analysis</a></li>
<li><a href="#messagequeue">MessageQueue and Choreographer</a></li>
<li><a href="#apm">APM and Choreographer</a></li>
<li><a href="#vendor">Manufacturer Optimizations</a></li>
<li><a href="#refs">Reference Materials</a></li>
<li><a href="#zhihu">Zhihu Address</a></li>
<li><a href="#about">About Me &amp; Blog</a></li>
</ul>
<p>This is the fifth article in the Perfetto series, mainly giving a brief introduction to Choreographer in Perfetto.</p>
<p>The <strong>purpose</strong> of this series is to view the overall operation of the Android system from another perspective through the Perfetto tool, and also to learn about the Framework from a different angle. Maybe you have read many articles about the Framework, but always can’t remember the code, or are not clear about its running process. Perhaps from the graphical perspective of Perfetto, you can understand it more deeply.</p>
<p><a id="series"></a></p>
<h1 id="Perfetto-Series-Catalog"><a href="#Perfetto-Series-Catalog" class="headerlink" title="Perfetto Series Catalog"></a>Perfetto Series Catalog</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/2024/03/27/Android-Perfetto-101/#/Perfetto-%E7%B3%BB%E5%88%97%E7%9B%AE%E5%BD%95">Android Perfetto Series Catalog</a></li>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/2024/05/21/Android-Perfetto-01-What-is-perfetto/">Android Perfetto Series 1: Introduction to Perfetto</a></li>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/2024/05/21/Android-Perfetto-02-how-to-get-perfetto/">Android Perfetto Series 2: Perfetto Trace Capture</a></li>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/2024/05/21/Android-Perfetto-03-how-to-analysis-perfetto/">Android Perfetto Series 3: Familiarizing with Perfetto View</a></li>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/2025/02/08/Android-Perfetto-04-Open-Big-Trace-With-Command-Line/">Android Perfetto Series 4: Opening Large Traces Locally with Command Line</a></li>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/2025/03/26/Android-Perfetto-05-Chorergrapher/">Android Perfetto Series 5: Android App Choreographer-based Rendering Flow</a></li>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/2025/04/26/Android-Perfetto-06-Why-120Hz/">Android Perfetto Series 6: Why 120Hz? Advantages and Challenges of High Refresh Rate</a></li>
<li><a href="https://androidperformance.com/2025/08/02/Android-Perfetto-07-MainThread-And-RenderThread/">Android Perfetto Series 7: MainThread and RenderThread Interpretation</a></li>
<li><a href="https://androidperformance.com/2025/08/05/Android-Perfetto-08-Vsync/">Android Perfetto Series 8: Indepth Understanding of Vsync Mechanism and Performance Analysis</a></li>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/2025/11/12/Android-Perfetto-09-CPU/">Android Perfetto Series 9: CPU Information Interpretation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1oi82efE4D/?vd_source=0c6d2191e785de0a36dc21a9da7e664e">Video (Bilibili) - Android Perfetto Basics and Case Sharing</a></li>
</ol>
<p>If you haven’t seen the Systrace series yet, here is the portal:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/2019/05/26/Android_Systrace_0/#/%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95">Systrace Series Catalog</a>: Systematically introduces the use of Systrace, the predecessor of Perfetto, and learns and understands the basic rules of Android performance optimization and Android system operation through Systrace.</li>
<li>Systrace version of this article: <a href="https://androidperformance.com/2019/10/22/Android-Choreographer/">Detailed Explanation of Android Choreographer-based Rendering Mechanism</a></li>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/">Personal Blog</a>: Personal blog, mainly Android-related content, also contains some life and work-related content.</li>
</ol>
<p>Everyone is welcome to join the WeChat group or Planet on the <a target="_blank" rel="noopener" href="https://www.androidperformance.com/about/">About Me</a> page to discuss your questions, the parts of Perfetto you most want to see, and discuss all Android development-related content with other group members.</p>
<p><a id="main-thread-essence"></a></p>
<h1 id="The-Essence-of-Main-Thread-Execution"><a href="#The-Essence-of-Main-Thread-Execution" class="headerlink" title="The Essence of Main Thread Execution"></a>The Essence of Main Thread Execution</h1><p>Before discussing Choreographer, let’s first clarify the essence of Android’s main thread operation, which is actually the processing process of Messages. Our various operations, including the rendering operations of each frame, are sent to the MessageQueue of the main thread in the form of Messages. The MessageQueue continues to wait for the next message after processing the current one, as shown in the figure below.</p>
<p><strong>MethodTrace Illustration</strong></p>
<p><img src="/en/images/15717420275540.jpg"></p>
<p><strong>Perfetto Illustration</strong></p>
<p><img src="/en/images/Android-Perfetto-05-Chorergrapher/image-20250331235337987.png" alt="image-20250331235337987"></p>
<h2 id="Evolution"><a href="#Evolution" class="headerlink" title="Evolution"></a>Evolution</h2><p>In Android versions before the introduction of Vsync, there was no interval between Messages related to rendering a frame. As soon as the previous frame was drawn, the Message for the next frame began to be processed immediately. The problem with this was that the frame rate was unstable, potentially high or low, as shown below:</p>
<p><strong>MethodTrace Illustration</strong></p>
<p><img src="/en/images/15717420453069.jpg"></p>
<p><strong>Trace Illustration (Resource is relatively old, using Systrace illustration)</strong></p>
<p><img src="/en/images/15717420572997.jpg"></p>
<p>It can be seen that the bottleneck at this time was in <code>dequeueBuffer</code>. Because the screen has a refresh cycle, the speed at which FB consumes the Front Buffer is constant, so the speed at which SF consumes the App Buffer is also constant. Therefore, the App would get stuck at <code>dequeueBuffer</code>. This would lead to unstable acquisition of the App Buffer, easily causing stuttering and dropped frames.</p>
<p>For users, a stable frame rate is a good experience. For example, when playing Honor of Kings, compared to frequent fluctuations between 60 and 40 fps, users feel better when it is stable at 50 fps.</p>
<p>Therefore, in the evolution of Android, the mechanism of <strong>Vsync + TripleBuffer + Choreographer</strong> was initially introduced. Later, in the Android S (Android 12) version, <strong>BlastBufferQueue</strong> was further introduced, jointly forming the modern Android stable frame rate output mechanism, allowing the software layer and hardware layer to work together at a common frequency.</p>
<h2 id="Introducing-Choreographer"><a href="#Introducing-Choreographer" class="headerlink" title="Introducing Choreographer"></a>Introducing Choreographer</h2><p>The introduction of Choreographer is mainly to cooperate with Vsync to provide a stable Message processing timing for upper-layer application rendering. When the Vsync signal arrives, the system controls the timing of each frame’s drawing operation by adjusting the Vsync signal cycle. Currently, the screen refresh rate of mainstream mobile phones has reached 120Hz, which means refreshing once every 8.3ms. The system adjusts the Vsync cycle accordingly to match the screen refresh frequency. When each Vsync cycle arrives, the Vsync signal wakes up the Choreographer to execute the application’s drawing operation. If the application can complete rendering in each Vsync cycle, the application’s fps will be 120, and the user feels very smooth. This is the main function of introducing Choreographer.</p>
<p><img src="/en/images/15722752299458.jpg"></p>
<p>Of course, the refresh rate of mainstream flagship mobile phones has reached 120Hz, and the Vsync cycle has been shortened to 8.3ms. The operations in the above figure must be completed in a shorter time, and the performance requirements are getting higher and higher. For details, please refer to the article <a target="_blank" rel="noopener" href="https://www.androidperformance.com/2019/05/15/90hz-on-android/">New Smooth Experience, 90Hz Rambling</a> (although the article discusses 90Hz, the same principle applies to 120Hz).</p>
<p><a id="choreographer-intro"></a></p>
<h1 id="Introduction-to-Choreographer"><a href="#Introduction-to-Choreographer" class="headerlink" title="Introduction to Choreographer"></a>Introduction to Choreographer</h1><p>Choreographer plays a connecting role in the Android rendering pipeline.</p>
<ol>
<li><strong>Upstream connection</strong>: Responsible for receiving and processing various update messages and callbacks from the App, and processing them uniformly when Vsync arrives. For example, centralized processing of Input (mainly processing of Input events), Animation (animation related), Traversal (including measure, layout, draw, etc. operations), judging stuck frames and dropped frames, recording Callback time consumption, etc.</li>
<li><strong>Downstream connection</strong>: Responsible for requesting and receiving Vsync signals. Receive Vsync event callbacks (via <code>FrameDisplayEventReceiver.onVsync</code>); Request Vsync (<code>FrameDisplayEventReceiver.scheduleVsync</code>).</li>
</ol>
<p>From the above, it can be seen that Choreographer plays a key coordinator role in the Android rendering pipeline. Its importance lies in ensuring that Android applications can run at a stable frame rate (60 fps, 90 fps, or 120 fps) through the complete rendering mechanism of <strong>Choreographer + SurfaceFlinger + Vsync + BlastBufferQueue</strong>, effectively reducing visual discomfort caused by frame rate fluctuations.</p>
<p>Understanding Choreographer can also help application developers deeply understand the operating principle of each frame, and at the same time deepen their understanding of core components such as <strong>Message</strong>, <strong>Handler</strong>, <strong>Looper</strong>, <strong>MessageQueue</strong>, <strong>Input</strong>, <strong>Animation</strong>, <strong>Measure</strong>, <strong>Layout</strong>, and <strong>Draw</strong>. Many <strong>APM</strong> (Application Performance Monitoring) tools also utilize the combination mechanisms of <strong>Choreographer</strong> (via FrameCallback + FrameInfo), <strong>MessageQueue</strong> (via IdleHandler), and <strong>Looper</strong> (via custom MessageLogging) for performance monitoring. After deeply understanding these mechanisms, developers can conduct performance optimization more specifically and form systematic optimization ideas.</p>
<p>In addition, although charts are an effective way to explain processes, this article will rely more on the visual output of Perfetto and MethodTrace tools. Perfetto displays the operating status of the entire system in a timeline manner (from left to right), covering the activities of key components such as CPU, SurfaceFlinger, SystemServer, and application processes. Using <strong>Perfetto</strong> and <strong>MethodTrace</strong> can intuitively display key execution processes. Once you are familiar with the system code, Perfetto’s output can be directly mapped to the actual running status of the device. Therefore, in addition to citing a small number of network charts, this article mainly relies on Perfetto to display analysis results.</p>
<h2 id="Choreographer’s-Workflow-from-the-Perspective-of-Perfetto"><a href="#Choreographer’s-Workflow-from-the-Perspective-of-Perfetto" class="headerlink" title="Choreographer’s Workflow from the Perspective of Perfetto"></a>Choreographer’s Workflow from the Perspective of Perfetto</h2><p>The figure below uses sliding the settings interface as an example. Let’s first look at a complete preview of the settings interface from top to bottom. It can be seen that in Perfetto, from left to right, each green frame represents a frame, representing the picture we can finally see on the phone.</p>
<ol>
<li>The interval of each VSYNC-app value in the figure is a Vsync time, corresponding to the refresh rate of the current device, such as 16.6ms at 60Hz and 8.3ms at 120Hz. The rising edge or falling edge is the arrival time of Vsync.</li>
<li>Processing flow of each frame: Receive Vsync signal callback -&gt; UI Thread –&gt; RenderThread –&gt; SurfaceFlinger</li>
<li>UI Thread and RenderThread can complete the rendering of one frame of the App. In the latest Android 15, through the BlastBufferQueue mechanism, the rendered Buffer is thrown to SurfaceFlinger for composition, and then we can see this frame on the screen.</li>
<li>It can be seen that the time consumption of each frame of Settings sliding is very short (Ui Thread time consumption + RenderThread time consumption), but due to the existence of Vsync, each frame will wait until Vsync to be processed.</li>
</ol>
<p><img src="/en/images/Android-Perfetto-05-Chorergrapher/image-20250401001138400.png" alt="image-20250401001138400"></p>
<p>With the overall concept above, let’s zoom in on each frame of the UI Thread to see the position of the Choreographer and how the Choreographer organizes each frame.</p>
<p><img src="/en/images/Android-Perfetto-05-Chorergrapher/image-20250401002047386.png" alt="image-20250401002047386"></p>
<h2 id="Choreographer’s-Workflow"><a href="#Choreographer’s-Workflow" class="headerlink" title="Choreographer’s Workflow"></a>Choreographer’s Workflow</h2><ol>
<li>Choreographer Initialization</li>
<li>Initialize FrameHandler, bind Looper</li>
<li>Initialize FrameDisplayEventReceiver, establish communication with SurfaceFlinger for receiving and requesting Vsync</li>
<li>Initialize CallBackQueues</li>
<li>SurfaceFlinger’s appEventThread wakes up and sends Vsync, Choreographer callbacks <code>FrameDisplayEventReceiver.onVsync</code>, entering Choreographer’s main processing function <code>doFrame</code></li>
<li><code>Choreographer.doFrame</code> calculates frame drop logic</li>
<li><code>Choreographer.doFrame</code> processes Choreographer’s first callback: input</li>
<li><code>Choreographer.doFrame</code> processes Choreographer’s second callback: animation</li>
<li><code>Choreographer.doFrame</code> processes Choreographer’s third callback: insets animation</li>
<li><code>Choreographer.doFrame</code> processes Choreographer’s fourth callback: traversal</li>
<li>UIThread and RenderThread synchronize data in traversal-draw</li>
<li><code>Choreographer.doFrame</code> processes Choreographer’s fifth callback: commit</li>
<li>RenderThread processes drawing commands</li>
<li>In Android S (Android 12) and above versions, RenderThread submits drawing content to SurfaceFlinger through BlastBufferQueue</li>
<li>BlastBufferQueue is created and managed by the App side</li>
<li>Works through producer (BBQ_BufferQueue_Producer) and consumer (BufferQueue_Consumer) models</li>
<li>The UI thread does not have to wait for the RenderThread to complete, and can prepare the next frame earlier, reducing main thread blocking</li>
</ol>
<p><strong>After the first step of initialization is completed, subsequent steps will loop between steps 2-10</strong></p>
<p>Also attached is the MethodTrace corresponding to this frame (just a preview here, there will be a detailed large picture below)</p>
<p><img src="/en/images/15717420948412.jpg"></p>
<h2 id="Interaction-between-Choreographer-RenderThread-and-BlastBufferQueue"><a href="#Interaction-between-Choreographer-RenderThread-and-BlastBufferQueue" class="headerlink" title="Interaction between Choreographer, RenderThread and BlastBufferQueue"></a>Interaction between Choreographer, RenderThread and BlastBufferQueue</h2><p>In Android S (Android 12), the interaction between RenderThread and SurfaceFlinger has undergone important changes, the core of which is the introduction of BlastBufferQueue. Let’s see how this mechanism works.</p>
<h3 id="BlastBufferQueue-Working-Principle"><a href="#BlastBufferQueue-Working-Principle" class="headerlink" title="BlastBufferQueue Working Principle"></a>BlastBufferQueue Working Principle</h3><p>BlastBufferQueue is a BufferQueue variant optimized for UI rendering. It replaces the BufferQueue strictly created by SurfaceFlinger and is instead created and managed by the App side, used for buffer management between App and SurfaceFlinger.</p>
<ol>
<li><p><strong>More efficient buffer management</strong><br>In the traditional BufferQueue, the App needs to get an available buffer through <code>dequeueBuffer</code>, then render content, and finally submit the buffer to SurfaceFlinger through <code>queueBuffer</code>. In this process, if there is no available buffer, the App needs to wait, which leads to blocking.</p>
<p>BlastBufferQueue reduces this waiting through smarter buffer management, especially on high refresh rate devices, the effect is more obvious.</p>
</li>
<li><p><strong>Decoupling of RenderThread and UI Thread</strong><br>Before Android S, the UI thread (main thread) needed to wait for the RenderThread to complete its work before it could continue to process the next frame. In the new architecture, the UI thread can finish its work earlier, hand over the rendering task to the RenderThread, and then prepare for the work of the next frame without waiting for the current frame to be completely rendered.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In ViewRootImpl.performTraversals()</span></span><br><span class="line"><span class="comment">// Old version needs to wait for draw to complete</span></span><br><span class="line">performDraw(); <span class="comment">// This will block waiting for RenderThread</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// After BlastBufferQueue introduction</span></span><br><span class="line">scheduleTraversals(); <span class="comment">// Can prepare for the next frame earlier</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Creation Mechanism</strong><br>BlastBufferQueue is created during the <code>relayoutWindow</code> process of <code>ViewRootImpl</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example code for creating BBQ</span></span><br><span class="line"><span class="keyword">if</span> (mBlastBufferQueue == <span class="literal">null</span>) &#123;</span><br><span class="line">    mBlastBufferQueue = <span class="keyword">new</span> <span class="title class_">BLASTBufferQueue</span>(mTag, mSurfaceControl,</span><br><span class="line">        mSurfaceSize.x, mSurfaceSize.y,</span><br><span class="line">        mWindowAttributes.format);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Cooperation with Choreographer</strong><br>Choreographer is still the core that coordinates all this. When the Vsync signal arrives, Choreographer will trigger <code>doFrame</code> and execute various callbacks, among which <code>CALLBACK_TRAVERSAL</code> will trigger <code>ViewRootImpl</code>‘s <code>performTraversals()</code>, eventually going to the draw process.</p>
<p>In the draw process, through BlastBufferQueue, RenderThread can work more independently, and the UI thread can return earlier to process other tasks.</p>
</li>
</ol>
<p>Below we will look at the specific implementation from the perspective of source code.</p>
<p><a id="source"></a></p>
<h1 id="Source-Code-Analysis"><a href="#Source-Code-Analysis" class="headerlink" title="Source Code Analysis"></a>Source Code Analysis</h1><p>Below is a brief look from the source code perspective. The source code only excerpts some important logic, other logic is removed. In addition, the Native part interacting with SurfaceFlinger is not included, which is not the focus of this article. Those interested can follow it themselves. The following source code is based on the latest implementation of Android 15.</p>
<h2 id="Choreographer-Initialization"><a href="#Choreographer-Initialization" class="headerlink" title="Choreographer Initialization"></a>Choreographer Initialization</h2><h3 id="Choreographer-Singleton-Initialization"><a href="#Choreographer-Singleton-Initialization" class="headerlink" title="Choreographer Singleton Initialization"></a>Choreographer Singleton Initialization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Thread local storage for the choreographer.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Choreographer&gt; sThreadInstance =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Choreographer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Choreographer <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Get Looper of current thread</span></span><br><span class="line">        <span class="type">Looper</span> <span class="variable">looper</span> <span class="operator">=</span> Looper.myLooper();</span><br><span class="line">        <span class="keyword">if</span> (looper == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The current thread must have a looper!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Construct Choreographer object, use VSYNC_SOURCE_APP as Vsync source</span></span><br><span class="line">        <span class="type">Choreographer</span> <span class="variable">choreographer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Choreographer</span>(looper, VSYNC_SOURCE_APP);</span><br><span class="line">        <span class="keyword">if</span> (looper == Looper.getMainLooper()) &#123;</span><br><span class="line">            mMainInstance = choreographer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> choreographer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Choreographer-Constructor"><a href="#Choreographer-Constructor" class="headerlink" title="Choreographer Constructor"></a>Choreographer Constructor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">Choreographer</span><span class="params">(Looper looper, <span class="type">int</span> vsyncSource)</span> &#123;</span><br><span class="line">    mLooper = looper;</span><br><span class="line">    <span class="comment">// 1. Initialize FrameHandler</span></span><br><span class="line">    mHandler = <span class="keyword">new</span> <span class="title class_">FrameHandler</span>(looper);</span><br><span class="line">    <span class="comment">// 2. Initialize DisplayEventReceiver</span></span><br><span class="line">    mDisplayEventReceiver = USE_VSYNC</span><br><span class="line">            ? <span class="keyword">new</span> <span class="title class_">FrameDisplayEventReceiver</span>(looper, vsyncSource)</span><br><span class="line">            : <span class="literal">null</span>;</span><br><span class="line">    mLastFrameTimeNanos = Long.MIN_VALUE;</span><br><span class="line">    mFrameIntervalNanos = (<span class="type">long</span>)(<span class="number">1000000000</span> / getRefreshRate());</span><br><span class="line">    <span class="comment">//3. Initialize CallbacksQueues</span></span><br><span class="line">    mCallbackQueues = <span class="keyword">new</span> <span class="title class_">CallbackQueue</span>[CALLBACK_LAST + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= CALLBACK_LAST; i++) &#123;</span><br><span class="line">        mCallbackQueues[i] = <span class="keyword">new</span> <span class="title class_">CallbackQueue</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FrameHandler"><a href="#FrameHandler" class="headerlink" title="FrameHandler"></a>FrameHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FrameHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_DO_FRAME:<span class="comment">// Start operation for the next frame</span></span><br><span class="line">                doFrame(System.nanoTime(), <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_DO_SCHEDULE_VSYNC:<span class="comment">// Request Vsync </span></span><br><span class="line">                doScheduleVsync();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_DO_SCHEDULE_CALLBACK:<span class="comment">// Handle Callback</span></span><br><span class="line">                doScheduleCallback(msg.arg1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Choreographer-Initialization-Chain"><a href="#Choreographer-Initialization-Chain" class="headerlink" title="Choreographer Initialization Chain"></a>Choreographer Initialization Chain</h3><p>During the Activity startup process, after <code>onResume</code> is executed, <code>Activity.makeVisible()</code> is called, and then <code>addView()</code> is called. The calls layer by layer enter the following method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ActivityThread.handleResumeActivity(IBinder, <span class="type">boolean</span>, <span class="type">boolean</span>, String) (android.app) </span><br><span class="line">--&gt;WindowManagerImpl.addView(View, LayoutParams) (android.view) </span><br><span class="line">  --&gt;WindowManagerGlobal.addView(View, LayoutParams, Display, Window) (android.view) </span><br><span class="line">    --&gt;ViewRootImpl.ViewRootImpl(Context, Display) (android.view) </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ViewRootImpl</span><span class="params">(Context context, Display display)</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        mChoreographer = Choreographer.getInstance();</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Introduction-to-FrameDisplayEventReceiver"><a href="#Introduction-to-FrameDisplayEventReceiver" class="headerlink" title="Introduction to FrameDisplayEventReceiver"></a>Introduction to FrameDisplayEventReceiver</h2><p>Vsync registration, application, and reception are all done through the <code>FrameDisplayEventReceiver</code> class, so let’s introduce it simply first. <code>FrameDisplayEventReceiver</code> inherits from <code>DisplayEventReceiver</code> and has three important methods:</p>
<ol>
<li><code>onVsync</code> – Vsync signal callback</li>
<li><code>run</code> – Execute <code>doFrame</code></li>
<li><code>scheduleVsync</code>  – Request Vsync signal</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FrameDisplayEventReceiver</span> <span class="keyword">extends</span> <span class="title class_">DisplayEventReceiver</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onVsync</span><span class="params">(<span class="type">long</span> timestampNanos, <span class="type">long</span> physicalDisplayId, <span class="type">int</span> frame, VsyncEventData eventData)</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        mTimestampNanos = timestampNanos;</span><br><span class="line">        mFrame = frame;</span><br><span class="line">        <span class="comment">// VsyncEventData added in Android 15 passes richer Vsync event data</span></span><br><span class="line">        mVsyncEventData = eventData;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> Message.obtain(mHandler, <span class="built_in">this</span>);</span><br><span class="line">        msg.setAsynchronous(<span class="literal">true</span>);</span><br><span class="line">        mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        mHavePendingVsync = <span class="literal">false</span>;</span><br><span class="line">        doFrame(mTimestampNanos, mFrame, mVsyncEventData);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scheduleVsync</span><span class="params">()</span> &#123;</span><br><span class="line">        ......  </span><br><span class="line">        nativeScheduleVsync(mReceiverPtr);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Vsync-Registration-in-Choreographer"><a href="#Vsync-Registration-in-Choreographer" class="headerlink" title="Vsync Registration in Choreographer"></a>Vsync Registration in Choreographer</h2><p>From the function call stack below, we can see that <code>Choreographer</code>‘s inner class <code>FrameDisplayEventReceiver.onVsync</code> is responsible for receiving Vsync callbacks and notifying UIThread to process data.</p>
<p>So how does <code>FrameDisplayEventReceiver</code> callback <code>onVsync</code> when the Vsync signal arrives? The answer is that during the initialization of <code>FrameDisplayEventReceiver</code>, it finally listens to the file handle. The corresponding initialization process is as follows:</p>
<p>android&#x2F;view&#x2F;Choreographer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">Choreographer</span><span class="params">(Looper looper, <span class="type">int</span> vsyncSource)</span> &#123;</span><br><span class="line">    mLooper = looper;</span><br><span class="line">    mDisplayEventReceiver = USE_VSYNC</span><br><span class="line">            ? <span class="keyword">new</span> <span class="title class_">FrameDisplayEventReceiver</span>(looper, vsyncSource)</span><br><span class="line">            : <span class="literal">null</span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>android&#x2F;view&#x2F;Choreographer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FrameDisplayEventReceiver</span><span class="params">(Looper looper, <span class="type">int</span> vsyncSource)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(looper, vsyncSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>android&#x2F;view&#x2F;DisplayEventReceiver.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DisplayEventReceiver</span><span class="params">(Looper looper, <span class="type">int</span> vsyncSource)</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    mMessageQueue = looper.getQueue();</span><br><span class="line">    mReceiverPtr = nativeInit(<span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;DisplayEventReceiver&gt;(<span class="built_in">this</span>), mMessageQueue,</span><br><span class="line">            vsyncSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Simply put, during the initialization of <code>FrameDisplayEventReceiver</code>, Vsync events are passed and requested through BitTube (essentially a socket pair). After SurfaceFlinger receives the Vsync event, it passes this event to <code>DisplayEventDispatcher</code> through BitTube via <code>appEventThread</code>. After <code>DisplayEventDispatcher</code> listens to the Vsync event through the receiver end of BitTube, it callbacks <code>Choreographer.FrameDisplayEventReceiver.onVsync</code>, triggering the start of frame drawing, as shown in the figure below:</p>
<p><img src="/en/images/15717421215251.jpg"></p>
<h3 id="DisplayEventReceiver-Communication-Details-with-SurfaceFlinger"><a href="#DisplayEventReceiver-Communication-Details-with-SurfaceFlinger" class="headerlink" title="DisplayEventReceiver Communication Details with SurfaceFlinger"></a>DisplayEventReceiver Communication Details with SurfaceFlinger</h3><p>In the Android system, <code>DisplayEventReceiver</code> calls the <code>nativeInit</code> method via JNI to establish a communication channel with the SurfaceFlinger service. This process involves several key steps:</p>
<ol>
<li><p><strong>Create NativeDisplayEventReceiver Object</strong>: After calling <code>nativeInit</code> in the Java layer, JNI creates a <code>NativeDisplayEventReceiver</code> instance for receiving Vsync signals.</p>
</li>
<li><p><strong>Get IDisplayEventConnection</strong>: Get <code>IDisplayEventConnection</code> via <code>ISurfaceComposer</code> interface. This is a Binder interface used to communicate with the SurfaceFlinger service.</p>
</li>
<li><p><strong>Establish BitTube Connection</strong>: BitTube is a communication mechanism based on socket pair, designed for high-frequency, small-data-volume cross-process communication. It creates an efficient communication channel between the App process and the SurfaceFlinger process.</p>
</li>
<li><p><strong>File Descriptor Listening</strong>: Listen to the file descriptor of BitTube via <code>Looper</code>. When a Vsync signal arrives, <code>Looper</code> will notify <code>DisplayEventDispatcher</code> to process the event.</p>
</li>
</ol>
<p>The entire communication flow is as follows:</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">App Process                                    SurfaceFlinger Process</span><br><span class="line">  |<span class="string">                                             </span>|</span><br><span class="line">  |<span class="string">-- Create DisplayEventReceiver -------------&gt;</span>|</span><br><span class="line">  |<span class="string">                                             </span>|</span><br><span class="line">  |<span class="string">&lt;- Return IDisplayEventConnection (Binder)---</span>|</span><br><span class="line">  |<span class="string">                                             </span>|</span><br><span class="line">  |<span class="string">-- Create BitTube --------------------------&gt;</span>|</span><br><span class="line">  |<span class="string">                                             </span>|</span><br><span class="line">  |<span class="string">&lt;- File Descriptor Exchange -----------------</span>|</span><br><span class="line">  |<span class="string">                                             </span>|</span><br><span class="line">  |<span class="string">-- Register File Descriptor to Looper -------</span>|</span><br><span class="line">  |<span class="string">                                             </span>|</span><br><span class="line">  |<span class="string">-- Request Vsync (requestNextVsync) --------&gt;</span>|</span><br><span class="line">  |<span class="string">                                             </span>|</span><br><span class="line">  |<span class="string">&lt;- Send Vsync Event Data --------------------</span>|</span><br><span class="line">  |<span class="string">                                             </span>|</span><br><span class="line">  |<span class="string">-- Looper Notify -&gt; handleEvent -------------</span>|</span><br><span class="line">  |<span class="string">                                             </span>|</span><br><span class="line">  |<span class="string">-- Callback Java Layer onVsync --------------</span>|</span><br><span class="line">  |<span class="string">                                             </span>|</span><br></pre></td></tr></table></figure>

<p>The advantage of this design is that it avoids using Binder to pass high-frequency Vsync event data, improving performance and real-time performance through direct socket communication, which is crucial for ensuring smooth UI rendering. At the same time, since BitTube uses file descriptors, it can be seamlessly integrated into Android’s Looper mechanism, enabling the entire system to work in an event-driven manner.</p>
<h2 id="Logic-of-Choreographer-Processing-a-Frame"><a href="#Logic-of-Choreographer-Processing-a-Frame" class="headerlink" title="Logic of Choreographer Processing a Frame"></a>Logic of Choreographer Processing a Frame</h2><p>The core of Choreographer’s drawing logic is in the <code>Choreographer.doFrame</code> function. As can be seen from the figure below, <code>FrameDisplayEventReceiver.onVsync</code> posts itself, and its <code>run</code> method directly calls <code>doFrame</code> to start the logic processing of a frame.</p>
<p>android&#x2F;view&#x2F;Choreographer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onVsync</span><span class="params">(<span class="type">long</span> timestampNanos, <span class="type">long</span> physicalDisplayId, <span class="type">int</span> frame, VsyncEventData eventData)</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    mTimestampNanos = timestampNanos;</span><br><span class="line">    mFrame = frame;</span><br><span class="line">    mVsyncEventData = eventData;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> Message.obtain(mHandler, <span class="built_in">this</span>);</span><br><span class="line">    msg.setAsynchronous(<span class="literal">true</span>);</span><br><span class="line">    mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    mHavePendingVsync = <span class="literal">false</span>;</span><br><span class="line">    doFrame(mTimestampNanos, mFrame, mVsyncEventData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>doFrame</code> function mainly does the following specific things:</p>
<ol>
<li>Calculate frame drop logic</li>
<li>Record frame drawing info</li>
<li>Execute <code>CALLBACK_INPUT</code>, <code>CALLBACK_ANIMATION</code>, <code>CALLBACK_INSETS_ANIMATION</code>, <code>CALLBACK_TRAVERSAL</code>, <code>CALLBACK_COMMIT</code></li>
</ol>
<h3 id="Recording-Frame-Drawing-Info"><a href="#Recording-Frame-Drawing-Info" class="headerlink" title="Recording Frame Drawing Info"></a>Recording Frame Drawing Info</h3><p><code>FrameInfo</code> in Choreographer is responsible for recording the drawing information of the frame. When <code>doFrame</code> is executed, the drawing time of each key node will be recorded down, which we can see using <code>dumpsys gfxinfo</code>. Of course, Choreographer only records a part, and the rest is recorded in hwui.</p>
<p>From these <code>FrameInfo</code> flags, we can see the recorded content. Later when we look at <code>dumpsys gfxinfo</code>, the data is arranged according to this.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FrameInfoFlags &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FRAME_TIMELINE_VSYNC_ID</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The intended vsync time, unadjusted by jitter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INTENDED_VSYNC</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Jitter-adjusted vsync time, this is what was used as input into the</span></span><br><span class="line">    <span class="comment">// animation &amp; drawing system</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VSYNC</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The id of the input event that caused the current frame</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INPUT_EVENT_ID</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When input event handling started</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HANDLE_INPUT_START</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When animation evaluations started</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ANIMATION_START</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When ViewRootImpl#performTraversals() started</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PERFORM_TRAVERSALS_START</span> <span class="operator">=</span> <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When View:draw() started</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DRAW_START</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When the frame needs to be ready by</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FRAME_DEADLINE</span> <span class="operator">=</span> <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When frame actually started.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FRAME_START_TIME</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Interval between two consecutive frames</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FRAME_INTERVAL</span> <span class="operator">=</span> <span class="number">11</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The <code>doFrame</code> function records the time from Vsync time to <code>markPerformTraversalsStart</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">doFrame</span><span class="params">(<span class="type">long</span> frameTimeNanos, <span class="type">int</span> frame, VsyncEventData eventData)</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    mFrameInfo.setVsync(intendedFrameTimeNanos, frameTimeNanos);</span><br><span class="line">    <span class="comment">// Handle CALLBACK_INPUT Callbacks </span></span><br><span class="line">    mFrameInfo.markInputHandlingStart();</span><br><span class="line">    <span class="comment">// Handle CALLBACK_ANIMATION Callbacks</span></span><br><span class="line">    mFrameInfo.markAnimationsStart();</span><br><span class="line">    <span class="comment">// Handle CALLBACK_INSETS_ANIMATION Callbacks</span></span><br><span class="line">    <span class="comment">// Handle CALLBACK_TRAVERSAL Callbacks</span></span><br><span class="line">    mFrameInfo.markPerformTraversalsStart();</span><br><span class="line">    <span class="comment">// Handle CALLBACK_COMMIT Callbacks</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Executing-Callbacks"><a href="#Executing-Callbacks" class="headerlink" title="Executing Callbacks"></a>Executing Callbacks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">doFrame</span><span class="params">(<span class="type">long</span> frameTimeNanos, <span class="type">int</span> frame, VsyncEventData eventData)</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// Handle CALLBACK_INPUT Callbacks </span></span><br><span class="line">    doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos);</span><br><span class="line">    <span class="comment">// Handle CALLBACK_ANIMATION Callbacks</span></span><br><span class="line">    doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);</span><br><span class="line">    <span class="comment">// Handle CALLBACK_INSETS_ANIMATION Callbacks</span></span><br><span class="line">    doCallbacks(Choreographer.CALLBACK_INSETS_ANIMATION, frameTimeNanos);</span><br><span class="line">    <span class="comment">// Handle CALLBACK_TRAVERSAL Callbacks</span></span><br><span class="line">    doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);</span><br><span class="line">    <span class="comment">// Handle CALLBACK_COMMIT Callbacks</span></span><br><span class="line">    doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Input Callback Call Stack</strong></p>
<p><strong>input callback</strong> generally executes <code>ViewRootImpl.ConsumeBatchedInputRunnable</code></p>
<p>android&#x2F;view&#x2F;ViewRootImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ConsumeBatchedInputRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        doConsumeBatchedInput(mChoreographer.getFrameTimeNanos());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">doConsumeBatchedInput</span><span class="params">(<span class="type">long</span> frameTimeNanos)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mConsumeBatchedInputScheduled) &#123;</span><br><span class="line">        mConsumeBatchedInputScheduled = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mInputEventReceiver != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mInputEventReceiver.consumeBatchedInputEvents(frameTimeNanos)</span><br><span class="line">                    &amp;&amp; frameTimeNanos != -<span class="number">1</span>) &#123;</span><br><span class="line">                scheduleConsumeBatchedInput();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        doProcessInputEvents();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Input events are processed and finally passed to <code>DecorView</code>‘s <code>dispatchTouchEvent</code>, which leads to the familiar Input event dispatching.</p>
<p><img src="/en/images/15717421837064.jpg"></p>
<p><strong>Animation Callback Call Stack</strong></p>
<p>Generally, when we call <code>View.postOnAnimation</code> frequently, <code>CALLBACK_ANIMATION</code> is used.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postOnAnimation</span><span class="params">(Runnable action)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">AttachInfo</span> <span class="variable">attachInfo</span> <span class="operator">=</span> mAttachInfo;</span><br><span class="line">    <span class="keyword">if</span> (attachInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">        attachInfo.mViewRootImpl.mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_ANIMATION, action, <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Postpone the runnable until we know</span></span><br><span class="line">        <span class="comment">// on which thread it needs to run.</span></span><br><span class="line">        getRunQueue().post(action);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So when is <code>View.postOnAnimation</code> generally used? I took a screenshot, you can check it yourself. The most contacted should be operations like <code>startScroll</code>, <code>Fling</code>.</p>
<p><img src="/en/images/15717421963577.jpg"></p>
<p>Its call stack depends on what it posts. Below is the fling animation after releasing the hand.</p>
<p><img src="/en/images/15717422041938.jpg"></p>
<p>In addition, our <code>Choreographer</code>‘s <code>FrameCallback</code> also uses <code>CALLBACK_ANIMATION</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postFrameCallbackDelayed</span><span class="params">(FrameCallback callback, <span class="type">long</span> delayMillis)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;callback must not be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    postCallbackDelayedInternal(CALLBACK_ANIMATION,</span><br><span class="line">            callback, FRAME_CALLBACK_TOKEN, delayMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Traversal Call Stack</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">scheduleTraversals</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// In order to increase priority, postSyncBarrier first</span></span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Really start executing measure, layout, draw</span></span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">doTraversal</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// removing SyncBarrier here</span></span><br><span class="line">mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line">        <span class="comment">// Really start</span></span><br><span class="line">        performTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performTraversals</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">// measure operation</span></span><br><span class="line">      <span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth() || mHeight != host.getMeasuredHeight() || contentInsetsChanged || updatedConfiguration) &#123;</span><br><span class="line">            performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// layout operation</span></span><br><span class="line">      <span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">          performLayout(lp, mWidth, mHeight);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// draw operation</span></span><br><span class="line">      <span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</span><br><span class="line">          performDraw();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>TraceView Example of doTraversal</strong></p>
<p><img src="/en/images/15717422180571.jpg"></p>
<h2 id="Next-Frame-Vsync-Request"><a href="#Next-Frame-Vsync-Request" class="headerlink" title="Next Frame Vsync Request"></a>Next Frame Vsync Request</h2><p>Due to the existence of operations such as animation, sliding, and Fling, we need a continuous and stable frame rate output mechanism. This involves the request logic of Vsync. In continuous operations, such as animation, sliding, and Fling, <code>doFrame</code> of each frame will trigger the application for the next Vsync according to the situation, so that we can obtain continuous Vsync signals.</p>
<p>See the call stack of <code>scheduleTraversals</code> below (<code>scheduleTraversals</code> will trigger Vsync request)<br><img src="/en/images/15724225347501.jpg"><br>We are familiar with <code>invalidate</code> and <code>requestLayout</code> triggering Vsync signal requests.</p>
<p>Let’s take Animation as an example to see how Animation drives the next Vsync to continuously update the screen.</p>
<h3 id="ObjectAnimator-Animation-Driving-Logic"><a href="#ObjectAnimator-Animation-Driving-Logic" class="headerlink" title="ObjectAnimator Animation Driving Logic"></a>ObjectAnimator Animation Driving Logic</h3><p>android&#x2F;animation&#x2F;ObjectAnimator.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>android&#x2F;animation&#x2F;ValueAnimator.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">boolean</span> playBackwards)</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    addAnimationCallback(<span class="number">0</span>); <span class="comment">// Add Animation Callback when animation starts</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addAnimationCallback</span><span class="params">(<span class="type">long</span> delay)</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    getAnimationHandler().addAnimationFrameCallback(<span class="built_in">this</span>, delay);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>android&#x2F;animation&#x2F;AnimationHandler.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addAnimationFrameCallback</span><span class="params">(<span class="keyword">final</span> AnimationFrameCallback callback, <span class="type">long</span> delay)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mAnimationCallbacks.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// post FrameCallback</span></span><br><span class="line">        getProvider().postFrameCallback(mFrameCallback);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mFrameCallback here callbacks doFrame, inside posts itself</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Choreographer.<span class="type">FrameCallback</span> <span class="variable">mFrameCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Choreographer</span>.FrameCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFrame</span><span class="params">(<span class="type">long</span> frameTimeNanos)</span> &#123;</span><br><span class="line">        doAnimationFrame(getProvider().getFrameTime());</span><br><span class="line">        <span class="keyword">if</span> (mAnimationCallbacks.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// post itself</span></span><br><span class="line">            getProvider().postFrameCallback(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Calling <code>postFrameCallback</code> will go to <code>mChoreographer.postFrameCallback</code>, where the Vsync request logic of <code>Choreographer</code> will be triggered.</p>
<p>android&#x2F;animation&#x2F;AnimationHandler.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postFrameCallback</span><span class="params">(Choreographer.FrameCallback callback)</span> &#123;</span><br><span class="line">    mChoreographer.postFrameCallback(callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>android&#x2F;view&#x2F;Choreographer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postCallbackDelayedInternal</span><span class="params">(<span class="type">int</span> callbackType,</span></span><br><span class="line"><span class="params">        Object action, Object token, <span class="type">long</span> delayMillis)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">dueTime</span> <span class="operator">=</span> now + delayMillis;</span><br><span class="line">        mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dueTime &lt;= now) &#123;</span><br><span class="line">            <span class="comment">// Request Vsync scheduleFrameLocked -&gt;scheduleVsyncLocked-&gt; mDisplayEventReceiver.scheduleVsync -&gt;nativeScheduleVsync</span></span><br><span class="line">            scheduleFrameLocked(now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</span><br><span class="line">            msg.arg1 = callbackType;</span><br><span class="line">            msg.setAsynchronous(<span class="literal">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, dueTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Through the <code>Animation.start</code> setting above, the <code>Choreographer.FrameCallback</code> interface is used to request the next Vsync every frame.<br><strong>TraceView Example of a Frame During Animation</strong></p>
<p><img src="/en/images/15717422327935.jpg"></p>
<h2 id="Source-Code-Summary"><a href="#Source-Code-Summary" class="headerlink" title="Source Code Summary"></a>Source Code Summary</h2><ol>
<li><p><strong>Choreographer</strong> is designed using a thread singleton mode and is strongly coupled with Looper. Each thread can only has one Choreographer instance, and it must be bound to a valid Looper object because its internal Handler relies on Looper for message dispatching. In applications, it is usually bound to the main thread’s Looper to ensure thread safety of UI operations.</p>
</li>
<li><p><strong>DisplayEventReceiver</strong> is an abstract base class, and its JNI implementation creates an <code>IDisplayEventConnection</code> object as a listener for Vsync signals. Through this mechanism, the Vsync interrupt signal sent by <code>AppEventThread</code> of SurfaceFlinger can be accurately delivered to the Choreographer instance. When the Vsync signal arrives, the system callbacks <code>onVsync</code> method of <code>DisplayEventReceiver</code>, triggering the rendering process.</p>
</li>
<li><p><strong>DisplayEventReceiver</strong> provides <code>scheduleVsync</code> method for requesting Vsync signals. When the application needs to update the UI, it first requests the next Vsync interrupt through this method, and then executes the actual drawing logic in the <code>onVsync</code> callback, ensuring that rendering is synchronized with the screen refresh.</p>
</li>
<li><p><strong>Choreographer</strong> defines the <code>FrameCallback</code> interface, and its <code>doFrame</code> method is called every time Vsync arrives. This design is of great significance to the Android animation system, enabling animations to be accurately synchronized with the screen refresh rate, providing a smoother and more power-saving animation experience compared to early self-timing implementations.</p>
</li>
<li><p><strong>Choreographer</strong>‘s core function is to receive Vsync signals and trigger callback functions registered through <code>postCallback</code>. The framework defines five types of callbacks, sorted by execution priority:</p>
<ol>
<li><strong>CALLBACK_INPUT</strong>: Handle input events, such as touch, key presses, etc.</li>
<li><strong>CALLBACK_ANIMATION</strong>: Handle various animation calculations and updates</li>
<li><strong>CALLBACK_INSETS_ANIMATION</strong>: Handle system inset animations, such as soft keyboard, status bar animations, etc.</li>
<li><strong>CALLBACK_TRAVERSAL</strong>: Handle measurement, layout, and drawing of the view tree</li>
<li><strong>CALLBACK_COMMIT</strong>: Perform finishing work, including component memory recycling (<code>onTrimMemory</code>) and performance monitoring</li>
</ol>
</li>
<li><p><strong>ListView</strong> and <strong>RecyclerView</strong>‘s Item reuse mechanism (ViewHolder pattern) specific implementation at the framework level will involve <code>CALLBACK_INPUT</code> and <code>CALLBACK_ANIMATION</code> stages. When sliding or scrolling quickly, Item initialization, measurement, and drawing may be triggered in the Input callback (such as directly responding to touch events), or may be executed in the Animation callback (such as inertial sliding or automatic scrolling). RecyclerView, through a more efficient reuse mechanism and Prefetch strategy, can intelligently prepare ViewHolder in these two stages, reducing main thread blocking, performing especially well on high refresh rate devices.</p>
</li>
<li><p><strong>CALLBACK_INPUT</strong> and <strong>CALLBACK_ANIMATION</strong> will modify various properties of View (such as position, transparency, transformation matrix, etc.) during execution, so they must be executed before <code>CALLBACK_TRAVERSAL</code> to ensure that all state updates can be correctly applied during the measurement, layout, and drawing process of the current frame. This strict execution order guarantees the consistency and predictability of Android UI rendering.</p>
</li>
</ol>
<p><a id="apm"></a></p>
<h1 id="APM-and-Choreographer"><a href="#APM-and-Choreographer" class="headerlink" title="APM and Choreographer"></a>APM and Choreographer</h1><p>Due to the position of Choreographer, many performance monitoring means are done using Choreographer. In addition to the built-in dropped frame calculation, <code>FrameCallback</code> and <code>FrameInfo</code> provided by Choreographer expose interfaces to App, allowing App developers to monitor the performance of their own Apps through these methods. Commonly used methods are as follows:</p>
<ol>
<li><p>Use <code>doFrame</code> callback of <code>FrameCallback</code></p>
</li>
<li><p>Use <code>FrameInfo</code> for monitoring</p>
</li>
<li><p>Use: <code>adb shell dumpsys gfxinfo &lt;packagename&gt; framestats</code></p>
<ol>
<li>Example: <code>adb shell dumpsys gfxinfo com.meizu.flyme.launcher framestats</code></li>
</ol>
</li>
<li><p>Use <code>SurfaceFlinger</code> for monitoring</p>
<ol>
<li>Use: <code>adb shell dumpsys SurfaceFlinger --latency</code></li>
<li>Example: <code>adb shell dumpsys SurfaceFlinger --latency com.meizu.flyme.launcher/com.meizu.flyme.launcher.Launcher#0</code></li>
</ol>
</li>
<li><p>Use <code>SurfaceFlinger</code> PageFlip mechanism for monitoring</p>
<ol>
<li>Use: <code>adb service call SurfaceFlinger 1013</code></li>
<li>Remark: System permission required</li>
</ol>
</li>
<li><p>Choreographer’s own dropped frame calculation logic</p>
</li>
<li><p>BlockCanary performance monitoring based on Looper</p>
</li>
<li><p><strong>New: Powerful monitoring capabilities of Perfetto tool</strong></p>
<ol>
<li>In Android 15, Perfetto became the main performance analysis tool, replacing the early Systrace</li>
<li>Perfetto can capture more detailed system performance data, including Choreographer’s work details</li>
<li>Using Perfetto UI can visualize and analyze the frame rendering process</li>
</ol>
</li>
</ol>
<h2 id="Use-Perfetto-for-Advanced-Monitoring"><a href="#Use-Perfetto-for-Advanced-Monitoring" class="headerlink" title="Use Perfetto for Advanced Monitoring"></a>Use Perfetto for Advanced Monitoring</h2><p>Perfetto is Android’s new generation system tracking tool, which becomes the default performance analysis solution in Android 15. It provides more powerful functions than Systrace:</p>
<ol>
<li><p><strong>Comparison of comprehensive performance data collection</strong><br>Perfetto can collect multi-dimensional data such as CPU, memory, graphics rendering, system services, etc. at the same time</p>
</li>
<li><p><strong>Lower overhead</strong><br>Using efficient tracking engine, less impact on system performance</p>
</li>
<li><p><strong>Better Choreographer tracking</strong><br>Can track Choreographer’s work process in detail, including:</p>
<ul>
<li>Reception and processing of Vsync signals</li>
<li>Execution details of <code>doFrame</code> method</li>
<li>Execution time of various callbacks</li>
<li>The collaboration process between UI thread and RenderThread</li>
</ul>
</li>
<li><p><strong>Tracking BlastBufferQueue</strong><br>Can track the working process of the newly introduced BlastBufferQueue, helping developers understand the buffer management mechanism</p>
</li>
</ol>
<h3 id="Use-Perfetto-to-Track-Choreographer"><a href="#Use-Perfetto-to-Track-Choreographer" class="headerlink" title="Use Perfetto to Track Choreographer"></a>Use Perfetto to Track Choreographer</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start recording Perfetto trace</span></span><br><span class="line">adb shell perfetto --txt -c /data/misc/perfetto-configs/chrome-trace.config -o /data/misc/perfetto-traces/trace.perfetto-trace</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get trace file after completion</span></span><br><span class="line">adb pull /data/misc/perfetto-traces/trace.perfetto-trace</span><br><span class="line"></span><br><span class="line"><span class="comment"># Analyze in Perfetto UI (https://ui.perfetto.dev/)</span></span><br></pre></td></tr></table></figure>

<p>In Perfetto UI, you can find the event named “Choreographer#doFrame”, which shows the processing time and details of each frame. You can also check the collaboration relationship between the UI thread and RenderThread, and the interaction with SurfaceFlinger.</p>
<h2 id="Use-FrameInfo-for-Monitoring"><a href="#Use-FrameInfo-for-Monitoring" class="headerlink" title="Use FrameInfo for Monitoring"></a>Use FrameInfo for Monitoring</h2><p><code>adb shell dumpsys gfxinfo &lt;packagename&gt; framestats</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Window: StatusBar</span><br><span class="line">Stats since: 17990256398ns</span><br><span class="line">Total frames rendered: 1562</span><br><span class="line">Janky frames: 361 (23.11%)</span><br><span class="line">50th percentile: 6ms</span><br><span class="line">90th percentile: 23ms</span><br><span class="line">95th percentile: 36ms</span><br><span class="line">99th percentile: 101ms</span><br><span class="line">Number Missed Vsync: 33</span><br><span class="line">Number High input latency: 683</span><br><span class="line">Number Slow UI thread: 273</span><br><span class="line">Number Slow bitmap uploads: 8</span><br><span class="line">Number Slow issue draw commands: 18</span><br><span class="line">Number Frame deadline missed: 287</span><br><span class="line">HISTOGRAM: 5ms=670 6ms=128 7ms=84 8ms=63 9ms=38 10ms=23 11ms=21 12ms=20 13ms=25 14ms=39 15ms=65 16ms=36 17ms=51 18ms=37 19ms=41 20ms=20 21ms=19 22ms=18 23ms=15 24ms=14 25ms=8 26ms=4 27ms=6 28ms=3 29ms=4 30ms=2 31ms=2 32ms=6 34ms=12 36ms=10 38ms=9 40ms=3 42ms=4 44ms=5 46ms=8 48ms=6 53ms=6 57ms=4 61ms=1 65ms=0 69ms=2 73ms=2 77ms=3 81ms=4 85ms=1 89ms=2 93ms=0 97ms=2 101ms=1 105ms=1 109ms=1 113ms=1 117ms=1 121ms=2 125ms=1 129ms=0 133ms=1 150ms=2 200ms=3 250ms=0 300ms=1 350ms=1 400ms=0 450ms=0 500ms=0 550ms=0 600ms=0 650ms=0 </span><br><span class="line"></span><br><span class="line">---PROFILEDATA---</span><br><span class="line">Flags,IntendedVsync,Vsync,OldestInputEvent,NewestInputEvent,HandleInputStart,AnimationStart,PerformTraversalsStart,DrawStart,SyncQueued,SyncStart,IssueDrawCommandsStart,SwapBuffers,FrameCompleted,DequeueBufferDuration,QueueBufferDuration,</span><br><span class="line">0,10158314881426,10158314881426,9223372036854775807,0,10158315693363,10158315760759,10158315769821,10158316032165,10158316627842,10158316838988,10158318055915,10158320387269,10158321770654,428000,773000,</span><br><span class="line">0,10158332036261,10158332036261,9223372036854775807,0,10158332799196,10158332868519,10158332877269,10158333137738,10158333780654,10158333993206,10158335078467,10158337689561,10158339307061,474000,885000,</span><br><span class="line">0,10158348665353,10158348665353,9223372036854775807,0,10158349710238,10158349773102,10158349780863,10158350405863,10158351135967,10158351360446,10158352300863,10158354305654,10158355814509,471000,836000,</span><br><span class="line">0,10158365296729,10158365296729,9223372036854775807,0,10158365782373,10158365821019,10158365825238,10158365975290,10158366547946,10158366687217,10158367240706,10158368429248,10158369291852,269000,476000,</span><br></pre></td></tr></table></figure>
<h2 id="Use-SurfaceFlinger-for-Monitoring"><a href="#Use-SurfaceFlinger-for-Monitoring" class="headerlink" title="Use SurfaceFlinger for Monitoring"></a>Use SurfaceFlinger for Monitoring</h2><p>Command explanation:</p>
<ol>
<li>The unit of data is nanoseconds, and the time starts from the boot time</li>
<li>Each command will get 128 lines of frame-related data</li>
</ol>
<p>Data:</p>
<ol>
<li>The first line of data indicates the refresh interval <code>refresh_period</code></li>
<li>Column 1: This part of the data indicates the time point when the application draws the image</li>
<li>Column 2: The vertical sync time before SF (software) submits the frame to H&#x2F;W (hardware) for drawing, that is, the timestamp submitted to hardware after each frame is drawn. This column is the vertical sync timestamp.</li>
<li>Column 3: The time point when SF submits the frame to H&#x2F;W, which is regarded as the time point when H&#x2F;W finishes receiving data from SF, and the time point when drawing is completed.</li>
</ol>
<p><strong>Frame Drop (Jank) Calculation</strong></p>
<p>Each line can get a value through the following formula, which is a standard we call <code>jankflag</code>. If the <code>jankflag</code> of the current line changes compared to the <code>jankflag</code> of the previous line, it is called a dropped frame.</p>
<p><code>ceil((C - A) / refresh-period)</code></p>
<h2 id="Use-SurfaceFlinger-PageFlip-Mechanism-for-Monitoring"><a href="#Use-SurfaceFlinger-PageFlip-Mechanism-for-Monitoring" class="headerlink" title="Use SurfaceFlinger PageFlip Mechanism for Monitoring"></a>Use SurfaceFlinger PageFlip Mechanism for Monitoring</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"><span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(<span class="string">&quot;android.ui.ISurfaceComposer&quot;</span>);</span><br><span class="line">mFlinger.transact(<span class="number">1013</span>, data, reply, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">pageFlipCount</span> <span class="operator">=</span> reply.readInt();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">frames</span> <span class="operator">=</span> pageFlipCount - mLastPageFlipCount;</span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> now - mLastUpdateTime;</span><br><span class="line">mFps = (<span class="type">float</span>) (frames * <span class="number">1e9</span> / duration);</span><br><span class="line">mLastPageFlipCount = pageFlipCount;</span><br><span class="line">mLastUpdateTime = now;</span><br><span class="line">reply.recycle();</span><br><span class="line">data.recycle();</span><br></pre></td></tr></table></figure>
<h2 id="Choreographer’s-Own-Dropped-Frame-Calculation-Logic"><a href="#Choreographer’s-Own-Dropped-Frame-Calculation-Logic" class="headerlink" title="Choreographer’s Own Dropped Frame Calculation Logic"></a>Choreographer’s Own Dropped Frame Calculation Logic</h2><p><code>SKIPPED_FRAME_WARNING_LIMIT</code> is 30 by default, controlled by the property <code>debug.choreographer.skipwarning</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (jitterNanos &gt;= mFrameIntervalNanos) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">skippedFrames</span> <span class="operator">=</span> jitterNanos / mFrameIntervalNanos;</span><br><span class="line">    <span class="keyword">if</span> (skippedFrames &gt;= SKIPPED_FRAME_WARNING_LIMIT) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;Skipped &quot;</span> + skippedFrames + <span class="string">&quot; frames!  &quot;</span></span><br><span class="line">                + <span class="string">&quot;The application may be doing too much work on its main thread.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="BlockCanary"><a href="#BlockCanary" class="headerlink" title="BlockCanary"></a>BlockCanary</h2><p>BlockCanary uses Looper’s message mechanism for performance monitoring. It achieves the purpose of monitoring performance by recording before and after each Message in the MessageQueue.</p>
<p>android&#x2F;os&#x2F;Looper.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">        <span class="type">Printer</span> <span class="variable">logging</span> <span class="operator">=</span> me.mLogging;</span><br><span class="line">        <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">            logging.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> +</span><br><span class="line">                    msg.callback + <span class="string">&quot;: &quot;</span> + msg.what);</span><br><span class="line">        &#125;</span><br><span class="line">        msg.target.dispatchMessage(msg);</span><br><span class="line">        <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">            logging.println(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> + msg.callback);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a id="messagequeue"></a></p>
<h1 id="MessageQueue-and-Choreographer"><a href="#MessageQueue-and-Choreographer" class="headerlink" title="MessageQueue and Choreographer"></a>MessageQueue and Choreographer</h1><p>In the Android message mechanism, asynchronous messages have special processing priority. The system can insert a barrier (Barrier) into the message queue through the <code>enqueueBarrier</code> method, so that all synchronous messages after the barrier cannot be executed temporarily until <code>removeBarrier</code> method is called to remove the barrier. Messages marked as asynchronous are not affected by the barrier and can be processed normally.</p>
<p>Messages are synchronous by default. Only by using the <code>setAsynchronous</code> method of Message (this method is a hidden API) can the message be set to asynchronous. When initializing Handler, specific parameters can be passed to specify that all messages sent by this Handler are asynchronous. In this case, the <code>enqueueMessage</code> method of Handler will automatically call the <code>setAsynchronous</code> method of Message.</p>
<p>The core value of asynchronous messages lies in being able to bypass message barriers to proceed execution. If there is no barrier set, asynchronous messages are processed in exactly the same way as synchronous messages. The <code>removeSyncBarrier</code> method can be used to remove the previously set barrier.</p>
<h2 id="An-Example-of-SyncBarrier-Used-in-Choreographer"><a href="#An-Example-of-SyncBarrier-Used-in-Choreographer" class="headerlink" title="An Example of SyncBarrier Used in Choreographer"></a>An Example of SyncBarrier Used in Choreographer</h2><p><code>postSyncBarrier</code> is called when <code>scheduleTraversals</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">scheduleTraversals</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// In order to increase priority, postSyncBarrier first</span></span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>removeSyncBarrier</code> is called when <code>doTraversal</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">doTraversal</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// Remove SyncBarrier here</span></span><br><span class="line">mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line">        <span class="comment">// Really start</span></span><br><span class="line">        performTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When Choreographer posts a Message, it sets these messages as Asynchronous, so the priority of these Messages in Choreographer will be relatively high.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</span><br><span class="line">msg.arg1 = callbackType;</span><br><span class="line">msg.setAsynchronous(<span class="literal">true</span>);</span><br><span class="line">mHandler.sendMessageAtTime(msg, dueTime);</span><br></pre></td></tr></table></figure>
<p><a id="vendor"></a></p>
<h1 id="Manufacturer-Optimizations"><a href="#Manufacturer-Optimizations" class="headerlink" title="Manufacturer Optimizations"></a>Manufacturer Optimizations</h1><p>Since system manufacturers can directly modify the source code, they also take advantage of this to do some functions and optimizations. However, due to confidentiality issues, the code will not be put up directly. I can roughly talk about the ideas. Those interested can discuss privately.</p>
<h2 id="Input-Event-Optimization"><a href="#Input-Event-Optimization" class="headerlink" title="Input Event Optimization"></a>Input Event Optimization</h2><p>Choreographer itself does not have input messages, but after modifying the source code, input messages can be directly given to Choreographer. With these Input messages, Choreographer can do some things, such as responding in advance without waiting for Vsync.</p>
<h2 id="Background-Animation-Optimization"><a href="#Background-Animation-Optimization" class="headerlink" title="Background Animation Optimization"></a>Background Animation Optimization</h2><p>When an Android application retreats to the background, if it is not terminated by the system, it may still continue to execute various operations. In some cases, the application will continue to call Animation Callback in Choreographer. Even if these animations are invisible to the user, the execution of these Callbacks is completely meaningless, but it will cause high CPU resource usage.</p>
<p>Therefore, system manufacturers will optimize for this situation in Choreographer, restricting background applications that do not meet the conditions from continuing to execute meaningless animation callbacks through a series of strategies, effectively reducing system resource usage.</p>
<p><img src="/en/images/15717422623134.jpg"></p>
<h2 id="Frame-Drawing-Optimization"><a href="#Frame-Drawing-Optimization" class="headerlink" title="Frame Drawing Optimization"></a>Frame Drawing Optimization</h2><p>Like input event optimization, since we have Input event information, in some scenarios we can notify SurfaceFlinger not to wait for Vsync to do composition operations directly.</p>
<h2 id="App-Launch-Optimization"><a href="#App-Launch-Optimization" class="headerlink" title="App Launch Optimization"></a>App Launch Optimization</h2><p>We said earlier that all operations of the main thread are based on <code>Message</code>. If an operation, a non-important <code>Message</code>, is arranged at the back of the queue, it will affect this operation; by rearranging <code>MessageQueue</code>, when the application starts, important startup <code>Message</code>s are placed in front of the queue to speed up the startup speed.</p>
<h2 id="Animation-Callback-Front-loading"><a href="#Animation-Callback-Front-loading" class="headerlink" title="Animation Callback Front-loading"></a>Animation Callback Front-loading</h2><p>After the main thread of the previous frame is finished, there is actually a period of idle time before the next Vsync. This period of time can actually be used to prepare for the next frame. Then we can advance the animation callback of the next frame to do it here, which can effectively use the idle time of the CPU and reduce dropped frames.</p>
<h2 id="Frame-Interpolation"><a href="#Frame-Interpolation" class="headerlink" title="Frame Interpolation"></a>Frame Interpolation</h2><p>Like Animation callback front-loading, after the main thread of the previous frame is finished, there is actually a period of idle time before the next Vsync. This period of time can actually be used to prepare for the next frame. It’s just that here we directly generate a new frame: that is, execute <code>doFrame</code> twice in one Vsync. Frame interpolation is equivalent to preparing the data of the next few frames in advance, so that when encountering a truly time-consuming frame, there will be no stuttering.</p>
<p>Frame interpolation implementation is mainly in sliding scenarios, used on sliding components that implement <code>OverScroller</code>, such as <code>ListView</code>, <code>RecyclerView</code>. Because if <code>OverScroller</code> is used, we will know the sliding time and distance when touch up, and we can do tricks (frame interpolation) in the middle, equivalent to drawing the content of the next few VSyncs in one Vsync.</p>
<h2 id="High-Refresh-Rate-Optimization"><a href="#High-Refresh-Rate-Optimization" class="headerlink" title="High Refresh Rate Optimization"></a>High Refresh Rate Optimization</h2><p>The high refresh rate (120 Hz) on modern Android devices shortens the Vsync interval from 16.6 ms to 8.3 ms, which brings huge performance and power consumption challenges. How to complete the necessary operations for rendering in one frame is a place that mobile phone manufacturers must think about and optimize:</p>
<ol>
<li>Performance performance and optimization of Super App</li>
<li>Game high frame rate cooperation</li>
<li>Logic of mutual switching between 120 fps, 90 fps and 60 fps</li>
</ol>
<p><a id="refs"></a></p>
<h1 id="Reference-Materials"><a href="#Reference-Materials" class="headerlink" title="Reference Materials"></a>Reference Materials</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/304f56f5d486">https://www.jianshu.com/p/304f56f5d486</a></li>
<li><a target="_blank" rel="noopener" href="http://gityuan.com/2017/02/25/choreographer/">http://gityuan.com/2017/02/25/choreographer/</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/view/Choreographer">https://developer.android.com/reference/android/view/Choreographer</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jishuwen.com/d/2Vcc">https://www.jishuwen.com/d/2Vcc</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/5c8772eee51d456cda2e8099">https://juejin.im/entry/5c8772eee51d456cda2e8099</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/142">Android Development Expert Class</a></li>
<li><a target="_blank" rel="noopener" href="https://perfetto.dev/">Perfetto - System profiling, app tracing, and trace analysis</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/studio/profile/perfetto-ui">Use Perfetto to analyze UI performance</a></li>
<li><a target="_blank" rel="noopener" href="https://source.android.com/docs/core/graphics/arch-bq-gralloc">BufferQueue and Gralloc</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/about/versions/15/features#graphics">Android 15 Graphics Rendering Optimization</a></li>
</ol>
<p><a id="zhihu"></a></p>
<h1 id="Zhihu-Address"><a href="#Zhihu-Address" class="headerlink" title="Zhihu Address"></a>Zhihu Address</h1><p>Since blog comments are inconvenient, if you want to like or communicate, please move to the Zhihu page of this article<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/87954949">Zhihu - Detailed Explanation of Android Choreographer-based Rendering Mechanism - Perfetto Version</a><br><a target="_blank" rel="noopener" href="https://juejin.im/post/5daedc65e51d457834735c65">Juejin - Detailed Explanation of Android Choreographer-based Rendering Mechanism - Perfetto Version</a></p>
<p><a id="about"></a></p>
<h1 id="About-Me-amp-Blog"><a href="#About-Me-amp-Blog" class="headerlink" title="About Me &amp; Blog"></a>About Me &amp; Blog</h1><p>Below is a personal introduction and related links. I look forward to communicating with you all!</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/about/">Blogger Personal Introduction</a>: Contains personal WeChat and WeChat group links.</li>
<li><a href="https://androidperformance.com/2019/12/01/BlogMap/">Blog Content Navigation</a>: A navigation of personal blog content.</li>
<li><a href="https://androidperformance.com/2018/05/07/Android-performance-optimization-skills-and-tools/">Excellent Blog Articles Collected and Organized by Individuals - Must-Know for Android Performance Optimization</a>: Welcome everyone to recommend yourself and recommend (WeChat private chat is fine)</li>
<li><a target="_blank" rel="noopener" href="https://www.androidperformance.com/2023/12/30/the-performance/">Android Performance Optimization Knowledge Planet</a>: Welcome to join, thanks for support~</li>
</ol>
<blockquote>
<p><strong>One person can go faster, a group of people can go further</strong></p>
</blockquote>
<p><img src="/en/images/WechatIMG581.png" alt="Wechat Scan"></p>
<pre><code>
</code></pre>

    </article>
    <!-- license -->
        <div class="license-wrapper">
            <p>Author：<a href="https://androidperformance.com/en">Gracker</a>
            <p>Link：<a href="https://androidperformance.com/en/2025/03/26/Android-Perfetto-05-Chorergrapher/">https://androidperformance.com/en/2025/03/26/Android-Perfetto-05-Chorergrapher/</a>
            <p>Publish date：<a href="https://androidperformance.com/en/2025/03/26/Android-Perfetto-05-Chorergrapher/">March 26th 2025, 6:55:11 pm</a>
            <p>Update date：<a href="https://androidperformance.com/en/2025/03/26/Android-Perfetto-05-Chorergrapher/">January 11th 2026, 8:56:53 pm</a>
            <p>License：This work is licensed under <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a></p>
        </div>
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
                <div class="nextSlogan">Next Post</div>
                <a href="/en/2025/04/26/Android-Perfetto-06-Why-120Hz/" title="Android Perfetto Series 6: Why 120Hz? Advantages and Challenges">
                    <div class="nextTitle">Android Perfetto Series 6: Why 120Hz? Advantages and Challenges</div>
                </a>
        </li>
        <li class="previous">
                <div class="prevSlogan">Previous Post</div>
                <a href="/en/2025/02/08/Android-Perfetto-04-Open-Big-Trace-With-Command-Line/" title="Android Perfetto Series 4: Opening Large Traces via Command Line">
                    <div class="prevTitle">Android Perfetto Series 4: Opening Large Traces via Command Line</div>
                </a>
        </li>
    </ul>
    <!-- comment -->
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->

            
            
            
            <!-- utteranc评论 -->

            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->

            
            
            
        </div>
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    <!-- Mathjax -->
</main>

                <!-- profile -->
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
        <div class="social">
                            <a href="mailto:Dreamtale.jg@gmail.com" class="iconfont-archer email" title="email" ></a>
                <a href="https://github.com/gracker" class="iconfont-archer github" target="_blank" title="github"></a>
                <span class="iconfont-archer wechat" title="wechat">
                    <img class="profile-qr" src="/en/assets/Wechat.jpeg" />
                </span>
                <span class="iconfont-archer qq" title="qq">
                    <img class="profile-qr" src="/en/553000664" />
                </span>
                <a href="https://weibo.com/gracker520" class="iconfont-archer weibo" target="_blank" title="weibo"></a>
                <a href="https://www.zhihu.com/people/gracker" class="iconfont-archer zhihu" target="_blank" title="zhihu"></a>
                <a href="https://twitter.com/Gracker_Gao" class="iconfont-archer twitter" target="_blank" title="twitter"></a>
                <a href="https://juejin.im/user/557b0590e4b052e031453d76" class="iconfont-archer juejin" target="_blank" title="juejin"></a>
                <a href="https://www.youtube.com/@grackers" class="iconfont-archer youtube" target="_blank" title="youtube"></a>
                <a href="/en/atom.xml" class="iconfont-archer rss" target="_blank" title="rss"></a>

        </div>
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
        <div class="website-approve">
                <span id="icp-approve" class="icp-approve">
                    <a href="https://beian.miit.gov.cn/" target="_blank">蜀 ICP 备 20016190 号</a>
                </span>
        </div>
</footer>

        </div>
        <!-- toc -->
            <div class="toc-wrapper toc-wrapper-loding" style=    top:50vh;
>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Table-of-Contents"><span class="toc-number">1.</span> <span class="toc-text">Table of Contents</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Perfetto-Series-Catalog"><span class="toc-number"></span> <span class="toc-text">Perfetto Series Catalog</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-Essence-of-Main-Thread-Execution"><span class="toc-number"></span> <span class="toc-text">The Essence of Main Thread Execution</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Evolution"><span class="toc-number">1.</span> <span class="toc-text">Evolution</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Introducing-Choreographer"><span class="toc-number">2.</span> <span class="toc-text">Introducing Choreographer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction-to-Choreographer"><span class="toc-number"></span> <span class="toc-text">Introduction to Choreographer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Choreographer%E2%80%99s-Workflow-from-the-Perspective-of-Perfetto"><span class="toc-number">1.</span> <span class="toc-text">Choreographer’s Workflow from the Perspective of Perfetto</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Choreographer%E2%80%99s-Workflow"><span class="toc-number">2.</span> <span class="toc-text">Choreographer’s Workflow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Interaction-between-Choreographer-RenderThread-and-BlastBufferQueue"><span class="toc-number">3.</span> <span class="toc-text">Interaction between Choreographer, RenderThread and BlastBufferQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BlastBufferQueue-Working-Principle"><span class="toc-number">3.1.</span> <span class="toc-text">BlastBufferQueue Working Principle</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Source-Code-Analysis"><span class="toc-number"></span> <span class="toc-text">Source Code Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Choreographer-Initialization"><span class="toc-number">1.</span> <span class="toc-text">Choreographer Initialization</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Choreographer-Singleton-Initialization"><span class="toc-number">1.1.</span> <span class="toc-text">Choreographer Singleton Initialization</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Choreographer-Constructor"><span class="toc-number">1.2.</span> <span class="toc-text">Choreographer Constructor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FrameHandler"><span class="toc-number">1.3.</span> <span class="toc-text">FrameHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Choreographer-Initialization-Chain"><span class="toc-number">1.4.</span> <span class="toc-text">Choreographer Initialization Chain</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction-to-FrameDisplayEventReceiver"><span class="toc-number">2.</span> <span class="toc-text">Introduction to FrameDisplayEventReceiver</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vsync-Registration-in-Choreographer"><span class="toc-number">3.</span> <span class="toc-text">Vsync Registration in Choreographer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DisplayEventReceiver-Communication-Details-with-SurfaceFlinger"><span class="toc-number">3.1.</span> <span class="toc-text">DisplayEventReceiver Communication Details with SurfaceFlinger</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Logic-of-Choreographer-Processing-a-Frame"><span class="toc-number">4.</span> <span class="toc-text">Logic of Choreographer Processing a Frame</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recording-Frame-Drawing-Info"><span class="toc-number">4.1.</span> <span class="toc-text">Recording Frame Drawing Info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Executing-Callbacks"><span class="toc-number">4.2.</span> <span class="toc-text">Executing Callbacks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Next-Frame-Vsync-Request"><span class="toc-number">5.</span> <span class="toc-text">Next Frame Vsync Request</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ObjectAnimator-Animation-Driving-Logic"><span class="toc-number">5.1.</span> <span class="toc-text">ObjectAnimator Animation Driving Logic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Source-Code-Summary"><span class="toc-number">6.</span> <span class="toc-text">Source Code Summary</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#APM-and-Choreographer"><span class="toc-number"></span> <span class="toc-text">APM and Choreographer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Use-Perfetto-for-Advanced-Monitoring"><span class="toc-number">1.</span> <span class="toc-text">Use Perfetto for Advanced Monitoring</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Use-Perfetto-to-Track-Choreographer"><span class="toc-number">1.1.</span> <span class="toc-text">Use Perfetto to Track Choreographer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Use-FrameInfo-for-Monitoring"><span class="toc-number">2.</span> <span class="toc-text">Use FrameInfo for Monitoring</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Use-SurfaceFlinger-for-Monitoring"><span class="toc-number">3.</span> <span class="toc-text">Use SurfaceFlinger for Monitoring</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Use-SurfaceFlinger-PageFlip-Mechanism-for-Monitoring"><span class="toc-number">4.</span> <span class="toc-text">Use SurfaceFlinger PageFlip Mechanism for Monitoring</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Choreographer%E2%80%99s-Own-Dropped-Frame-Calculation-Logic"><span class="toc-number">5.</span> <span class="toc-text">Choreographer’s Own Dropped Frame Calculation Logic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BlockCanary"><span class="toc-number">6.</span> <span class="toc-text">BlockCanary</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MessageQueue-and-Choreographer"><span class="toc-number"></span> <span class="toc-text">MessageQueue and Choreographer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#An-Example-of-SyncBarrier-Used-in-Choreographer"><span class="toc-number">1.</span> <span class="toc-text">An Example of SyncBarrier Used in Choreographer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Manufacturer-Optimizations"><span class="toc-number"></span> <span class="toc-text">Manufacturer Optimizations</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Input-Event-Optimization"><span class="toc-number">1.</span> <span class="toc-text">Input Event Optimization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Background-Animation-Optimization"><span class="toc-number">2.</span> <span class="toc-text">Background Animation Optimization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Frame-Drawing-Optimization"><span class="toc-number">3.</span> <span class="toc-text">Frame Drawing Optimization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#App-Launch-Optimization"><span class="toc-number">4.</span> <span class="toc-text">App Launch Optimization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Animation-Callback-Front-loading"><span class="toc-number">5.</span> <span class="toc-text">Animation Callback Front-loading</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Frame-Interpolation"><span class="toc-number">6.</span> <span class="toc-text">Frame Interpolation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#High-Refresh-Rate-Optimization"><span class="toc-number">7.</span> <span class="toc-text">High Refresh Rate Optimization</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference-Materials"><span class="toc-number"></span> <span class="toc-text">Reference Materials</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Zhihu-Address"><span class="toc-number"></span> <span class="toc-text">Zhihu Address</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#About-Me-amp-Blog"><span class="toc-number"></span> <span class="toc-text">About Me &amp; Blog</span></a>
            </div>
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    <div class="total-and-search">
        <div class="total-archive">
        Total : 121
        </div>
        <!-- search  -->
    </div>
    <div class="post-archive">
            <div class="archive-year"> 2025 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">11/16</span>
            <a class="archive-post-title" href="/en/2025/11/16/Android-Perfetto-10-Binder/">Android Perfetto Series 10: Binder Scheduling and Lock Contention</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/12</span>
            <a class="archive-post-title" href="/en/2025/11/12/Android-Perfetto-09-CPU/">Android Perfetto Series 9: CPU Information Interpretation</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/05</span>
            <a class="archive-post-title" href="/en/2025/08/05/Android-Perfetto-08-Vsync/">Android Perfetto Series 8: Understanding Vsync Mechanism and Performance Analysis</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/02</span>
            <a class="archive-post-title" href="/en/2025/08/02/Android-Perfetto-07-MainThread-And-RenderThread/">Android Perfetto Series 7: MainThread and RenderThread Deep Dive</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/26</span>
            <a class="archive-post-title" href="/en/2025/04/26/Android-Perfetto-06-Why-120Hz/">Android Perfetto Series 6: Why 120Hz? Advantages and Challenges</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/26</span>
            <a class="archive-post-title" href="/en/2025/03/26/Android-Perfetto-05-Chorergrapher/">Android Perfetto Series 5: Choreographer-based Rendering Flow</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/08</span>
            <a class="archive-post-title" href="/en/2025/02/08/Android-Perfetto-04-Open-Big-Trace-With-Command-Line/">Android Perfetto Series 4: Opening Large Traces via Command Line</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/08</span>
            <a class="archive-post-title" href="/en/2025/02/08/Android-ANR-02-How-to-analysis-ANR/">Android ANR Series 2: ANR Analysis Methodology and Key Logs</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/08</span>
            <a class="archive-post-title" href="/en/2025/02/08/Android-ANR-01-ANR-Design/">Android ANR Series 1: Understanding Android ANR Design Philosophy</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/08</span>
            <a class="archive-post-title" href="/en/2025/02/08/Android-ANR-03-ANR-Case-Share/">Android ANR Series 3 - ANR Case Studies</a>
        </li>
                </ul>
            <div class="archive-year"> 2024 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">05/21</span>
            <a class="archive-post-title" href="/en/2024/05/21/Android-Perfetto-01-What-is-perfetto/">Android Perfetto Series 1: Introduction to Perfetto</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/21</span>
            <a class="archive-post-title" href="/en/2024/05/21/Android-Perfetto-02-how-to-get-perfetto/">Android Perfetto Series 2: Capturing Perfetto Traces</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/21</span>
            <a class="archive-post-title" href="/en/2024/05/21/Android-Perfetto-03-how-to-analysis-perfetto/">Android Perfetto Series 3: Familiarizing with the Perfetto View</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/27</span>
            <a class="archive-post-title" href="/en/2024/03/27/Android-Perfetto-101/">Android Perfetto Series Catalog</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span>
            <a class="archive-post-title" href="/en/2024/01/01/2023-review/">Reflections on 2023: Health, Career, and the Future</a>
        </li>
                </ul>
            <div class="archive-year"> 2023 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/30</span>
            <a class="archive-post-title" href="/en/2023/12/30/the-performance/">Introduction to The Android Performance Knowledge Planet</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/21</span>
            <a class="archive-post-title" href="/en/2023/08/21/the-performance-design-of-os/">Performance Considerations in Operating System Design</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/14</span>
            <a class="archive-post-title" href="/en/2023/05/14/bad-android-app-with-system-permissions/">Can an App Really Do Whatever It Wants With System Permissions?</a>
        </li>
                </ul>
            <div class="archive-year"> 2022 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">03/27</span>
            <a class="archive-post-title" href="/en/2022/03/27/the-performance-tea-part-01/">The Performance Community Tea Talk - Episode 1</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/13</span>
            <a class="archive-post-title" href="/en/2022/03/13/android-systrace-cpu-state-running/">Systrace Thread CPU State Analysis Tips - Running</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/13</span>
            <a class="archive-post-title" href="/en/2022/03/13/android-systrace-cpu-state-sleep/">Systrace Thread CPU State Analysis Tips - Sleep and Uninterruptible Sleep</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/21</span>
            <a class="archive-post-title" href="/en/2022/01/21/android-systrace-cpu-state-runnable/">Systrace Thread CPU State Analysis Tips - Runnable</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/07</span>
            <a class="archive-post-title" href="/en/2022/01/07/Techniques-Philosophy-and-Tools-for-Android-Performance-Optimization/">Techniques, Philosophy, and Tools for Android Performance Optimization</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/07</span>
            <a class="archive-post-title" href="/en/2022/01/07/The-Performace-1-Performance-Tools/">Android Performance Optimization: Techniques, Methods, and Tools</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/03</span>
            <a class="archive-post-title" href="/en/2022/01/03/2021-Review/">2021 Year in Review: Baby, Career, and Growth</a>
        </li>
                </ul>
            <div class="archive-year"> 2021 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">10/27</span>
            <a class="archive-post-title" href="/en/2021/10/27/if-i-write-a-book-about-performance/">What Should Be in a Book About Android Smoothness?</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/26</span>
            <a class="archive-post-title" href="/en/2021/10/26/build-android-12/">Android System Development Series (1): Downloading, Compiling, and Flashing Android 12</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/13</span>
            <a class="archive-post-title" href="/en/2021/09/13/android-systrace-Responsiveness-in-action-1/">Android Systrace Responsiveness in Action 1 - Understanding Responsiveness Principles</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/13</span>
            <a class="archive-post-title" href="/en/2021/09/13/android-systrace-Responsiveness-in-action-2/">Android Systrace Responsiveness in Action 2 - Responsiveness Analysis - Using App Startup as an Example</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/13</span>
            <a class="archive-post-title" href="/en/2021/09/13/android-systrace-Responsiveness-in-action-3/">Android Systrace Responsiveness in Action 3 - Extended Knowledge on Responsiveness</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/24</span>
            <a class="archive-post-title" href="/en/2021/04/24/android-systrace-smooth-in-action-2/">Android Systrace Smoothness in Action 2 - Case Analysis - MIUI Launcher Scroll Jank Analysis</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/24</span>
            <a class="archive-post-title" href="/en/2021/04/24/android-systrace-smooth-in-action-3/">Android Systrace Smoothness in Action 3 - FAQs During Jank Analysis</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/24</span>
            <a class="archive-post-title" href="/en/2021/04/24/android-systrace-smooth-in-action-1/">Android Systrace Smoothness in Action 1 - Understanding Jank Principles</a>
        </li>
                </ul>
            <div class="archive-year"> 2020 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">08/20</span>
            <a class="archive-post-title" href="/en/2020/08/20/weibo-imageload-opt-on-huawei/">Why is the Weibo Experience Better on Huawei? A Technical Analysis and Reflection</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/26</span>
            <a class="archive-post-title" href="/en/2020/05/26/samsung_crash/">An Incident Caused by a 'Leap' Month - Analysis of Samsung System Reboots</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/07</span>
            <a class="archive-post-title" href="/en/2020/05/07/Android-App-Chain-Wakeup/">Analysis of Android App Chain Wakeups</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/14</span>
            <a class="archive-post-title" href="/en/2020/02/14/Android-Systrace-SurfaceFlinger/">Android Systrace Basics - SurfaceFlinger Explained</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/03</span>
            <a class="archive-post-title" href="/en/2020/02/03/android-development-learning-path-2020-edition/">Android Developer Learning Path (2020 Edition)</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/28</span>
            <a class="archive-post-title" href="/en/2020/01/28/2020-read/">My 2020 Reading List</a>
        </li>
                </ul>
            <div class="archive-year"> 2019 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/21</span>
            <a class="archive-post-title" href="/en/2019/12/21/Android-Systrace-CPU/">Android Systrace Basics - CPU Info Interpretation</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/15</span>
            <a class="archive-post-title" href="/en/2019/12/15/Android-Systrace-Triple-Buffer/">Android Systrace Basics - Triple Buffer Explained</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/06</span>
            <a class="archive-post-title" href="/en/2019/12/06/Android-Systrace-Binder/">Android Systrace Basics - Binder and Lock Contention Explained</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span>
            <a class="archive-post-title" href="/en/2019/12/01/BlogMap/">[Sticky] Blog Article Directory</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span>
            <a class="archive-post-title" href="/en/2019/12/01/Android-Systrace-Vsync/">Android Systrace Basics - Vsync Explained</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/18</span>
            <a class="archive-post-title" href="/en/2019/11/18/Android-App-Lunch-Optimize/">Comprehensive Record of Android App Startup Optimization</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/18</span>
            <a class="archive-post-title" href="/en/2019/11/18/Android-App-Lunch-Optimize-NEW/">Complete Guide to Android App Startup Optimization</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/06</span>
            <a class="archive-post-title" href="/en/2019/11/06/Android-Systrace-MainThread-And-RenderThread/">Android Systrace Basics - MainThread and RenderThread Explained</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/04</span>
            <a class="archive-post-title" href="/en/2019/11/04/Android-Systrace-Input/">Android Systrace Basics - Input Interpretation</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/24</span>
            <a class="archive-post-title" href="/en/2019/10/24/Android-Background-Animation/">Analysis of 'Zombie Animations' in the Android Background</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/22</span>
            <a class="archive-post-title" href="/en/2019/10/22/Android-Choreographer/">Detailed Explanation of Android Rendering Mechanism Based on Choreographer</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/18</span>
            <a class="archive-post-title" href="/en/2019/09/18/Android-Jank-Due-To-Low-Memory/">Overview of Jank and Frame Drops in Android - Low Memory</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/17</span>
            <a class="archive-post-title" href="/en/2019/09/17/Android-Kill-Background-App-Debug/">Case Study: Debugging the Android Launcher Kill Problem</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/05</span>
            <a class="archive-post-title" href="/en/2019/09/05/Android-Jank-Due-To-App/">Overview of Jank and Frame Drops in Android - Application Layer</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/05</span>
            <a class="archive-post-title" href="/en/2019/09/05/Android-Jank-Due-To-System/">Overview of Jank and Frame Drops in Android - System Layer</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/05</span>
            <a class="archive-post-title" href="/en/2019/09/05/Android-Jank-Debug/">Overview of Jank and Frame Drops in Android - Methodology</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/01</span>
            <a class="archive-post-title" href="/en/2019/09/01/Android-Activity-Lunch-Mode/">A Detailed Guide to Activity Launch Modes in Android</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/27</span>
            <a class="archive-post-title" href="/en/2019/07/27/Android-Hardware-Layer-NEW/">Detailed Explanation of Hardware Layer in Android</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/27</span>
            <a class="archive-post-title" href="/en/2019/07/27/Android-Hardware-Layer/">A Deep Dive into Hardware Layers in Android</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/23</span>
            <a class="archive-post-title" href="/en/2019/07/23/Android-Systrace-Pre/">Android Systrace Basics - Prerequisites for Analyzing Systrace</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/29</span>
            <a class="archive-post-title" href="/en/2019/06/29/Android-Systrace-SystemServer/">Android Systrace Basics - SystemServer Explained</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/28</span>
            <a class="archive-post-title" href="/en/2019/05/28/Android-Systrace-About/">Android Systrace Basics - Introduction to Systrace</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/27</span>
            <a class="archive-post-title" href="/en/2019/05/27/why-60-fps/">Android Systrace Basics - Why 60 FPS?</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/26</span>
            <a class="archive-post-title" href="/en/2019/05/26/Android_Systrace_0/">Android Systrace -- Series Article Index</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/15</span>
            <a class="archive-post-title" href="/en/2019/05/15/90hz-on-android/">A New Era of Smoothness: Thoughts on 90Hz on Android</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/07</span>
            <a class="archive-post-title" href="/en/2019/04/07/Sharp-Tools/">Sharp Tools - Efficient Tool Recommendations</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/07</span>
            <a class="archive-post-title" href="/en/2019/04/07/liqi/">Liqi - High-Efficiency Tools Recommendation</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/21</span>
            <a class="archive-post-title" href="/en/2019/01/21/android-performance-case-jank-accessbility/">Case Analysis of System-wide Stutter Caused by Android Accessibility Service</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/12</span>
            <a class="archive-post-title" href="/en/2019/01/12/recommend-of-2018/">2018 Best Items Recommendations - A Reward for Your Hard Work</a>
        </li>
                </ul>
            <div class="archive-year"> 2018 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">11/01</span>
            <a class="archive-post-title" href="/en/2018/11/01/android-system-develop-0/">Setting Up the Android System Development Environment</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/25</span>
            <a class="archive-post-title" href="/en/2018/10/25/How-do-engineers-count-well/">Lu Qi: Besides Good Code, What Makes an Engineer Excellent?</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/01</span>
            <a class="archive-post-title" href="/en/2018/10/01/how-to-stop-sucking-and-be-awesome-instead-8/">The Programmer's Apprenticeship - 08: The Beauty of Reading</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/30</span>
            <a class="archive-post-title" href="/en/2018/09/30/how-to-stop-sucking-and-be-awesome-instead-7/">The Programmer's Apprenticeship - 07: Games and Programming</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/29</span>
            <a class="archive-post-title" href="/en/2018/09/29/how-to-stop-sucking-and-be-awesome-instead-6/">The Programmer's Apprenticeship - 06: All About the Internet</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/28</span>
            <a class="archive-post-title" href="/en/2018/09/28/how-to-stop-sucking-and-be-awesome-instead-5/">The Programmer's Apprenticeship - 05: Know Your Users</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/27</span>
            <a class="archive-post-title" href="/en/2018/09/27/how-to-stop-sucking-and-be-awesome-instead-4/">The Programmer's Apprenticeship - 04: Reflections on Testing</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/26</span>
            <a class="archive-post-title" href="/en/2018/09/26/how-to-stop-sucking-and-be-awesome-instead-3/">The Programmer's Apprenticeship - 03: Web Design Principles</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/20</span>
            <a class="archive-post-title" href="/en/2018/09/20/how-to-stop-sucking-and-be-awesome-instead-2/">The Programmer's Apprenticeship - 02: The Way of Programming</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/19</span>
            <a class="archive-post-title" href="/en/2018/09/19/how-to-stop-sucking-and-be-awesome-instead-1/">The Programmer's Apprenticeship - 01: The Art of Fighting Back</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/13</span>
            <a class="archive-post-title" href="/en/2018/09/13/android-memory/">Does the Android System Not Release Memory?</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/13</span>
            <a class="archive-post-title" href="/en/2018/08/13/Some-Thoughts-on-the-Fluency-of-Android/">Some Thoughts on Android System Fluency</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/20</span>
            <a class="archive-post-title" href="/en/2018/05/20/zhihu-startingwindow/">Zhihu: Save Your StartingWindow</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/07</span>
            <a class="archive-post-title" href="/en/2018/05/07/Android-performance-optimization-skills-and-tools/">[Sticky] Android Performance Optimization: Must-Know Skills and Tools</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/06</span>
            <a class="archive-post-title" href="/en/2018/01/06/2017-most-recommended/">2017 Best Recommendations - A Reward for Hard-Working Self</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/06</span>
            <a class="archive-post-title" href="/en/2018/01/06/Most-Recommended-of-2017/">2017 Annual Best Recommendations - Reward Yourself for Hard Work</a>
        </li>
                </ul>
            <div class="archive-year"> 2017 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">04/23</span>
            <a class="archive-post-title" href="/en/2017/04/23/About-work/">Reflections on Work and Growth (2017)</a>
        </li>
                </ul>
            <div class="archive-year"> 2016 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">04/05</span>
            <a class="archive-post-title" href="/en/2016/04/05/android-bottom-bar-2/">Android Bottom Navigation Spec Part 2: Style, Behavior, and Dimensions</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/05</span>
            <a class="archive-post-title" href="/en/2016/04/05/android-bottom-bar-1/">Android Bottom Navigation Spec Part 1: Usage</a>
        </li>
                </ul>
            <div class="archive-year"> 2015 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/31</span>
            <a class="archive-post-title" href="/en/2015/12/31/How-to-calculation-android-app-lunch-time/">How to Calculate App Startup Time in Android?</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/29</span>
            <a class="archive-post-title" href="/en/2015/12/29/Android-App-Launch-Optimization-DelayLoad-Part-2/">Android App Launch Optimization: Implementation and Principles of DelayLoad (Part 2)</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/18</span>
            <a class="archive-post-title" href="/en/2015/11/18/Android-app-lunch-optimize-delay-load/">Android App Startup Optimization - DelayLoad Implementation and Principles (Part 1)</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/12</span>
            <a class="archive-post-title" href="/en/2015/08/12/AndroidL-hwui-RenderThread-workflow/">RenderThread Workflow in Android hwui</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/05</span>
            <a class="archive-post-title" href="/en/2015/08/05/HashMap/">Java 7 HashMap Source Code Analysis</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/20</span>
            <a class="archive-post-title" href="/en/2015/07/20/Android-Performance-Memory-onTrimMemory/">Android Code Memory Optimization Suggestions - OnTrimMemory</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/20</span>
            <a class="archive-post-title" href="/en/2015/07/20/Android-Performance-Memory-AndroidResource/">Android Code Memory Optimization Suggestions - Android Resources</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/20</span>
            <a class="archive-post-title" href="/en/2015/07/20/Android-Performance-Memory-Java/">Android Code Memory Optimization Suggestions - Java (Official)</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/20</span>
            <a class="archive-post-title" href="/en/2015/07/20/Android-Performance-Memory-Google/">Android Code Memory Optimization Suggestions - Android (Official)</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/29</span>
            <a class="archive-post-title" href="/en/2015/05/29/Nexus6-with-Android-M/">Enabling Multi-Window Mode on Nexus 6 with Android M</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/06</span>
            <a class="archive-post-title" href="/en/2015/05/06/Java-Singleton/">A Detailed Guide to Java Singleton Pattern</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/19</span>
            <a class="archive-post-title" href="/en/2015/04/19/Android-Performance-Patterns-3/">Android Performance Patterns: Understanding VSYNC</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/19</span>
            <a class="archive-post-title" href="/en/2015/04/19/Android-Performance-Patterns-1/">Android Performance Patterns: Render Performance</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/19</span>
            <a class="archive-post-title" href="/en/2015/04/19/Android-Performance-Patterns-2/">Android Performance Patterns: Understanding Overdraw</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/19</span>
            <a class="archive-post-title" href="/en/2015/04/19/Android-Performance-Patterns-4/">Android Performance Patterns: Profile GPU Rendering</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/19</span>
            <a class="archive-post-title" href="/en/2015/04/19/Android-Performance-Patterns/">Overview of Android Performance Patterns</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/11</span>
            <a class="archive-post-title" href="/en/2015/04/11/AndroidMemory-Open-Bitmap-Object-In-MAT/">Android Memory Optimization (3) - Viewing Original Bitmaps in MAT</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/11</span>
            <a class="archive-post-title" href="/en/2015/04/11/AndroidMemory-Usage-Of-MAT/">Android Memory Optimization (1) - Getting Started with MAT</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/11</span>
            <a class="archive-post-title" href="/en/2015/04/11/AndroidMemory-Usage-Of-MAT-Pro/">Android Memory Optimization (2) - Advanced MAT Usage</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/31</span>
            <a class="archive-post-title" href="/en/2015/03/31/android-performance-case-study-follow-up/">Android Performance Case Study Follow-up</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/15</span>
            <a class="archive-post-title" href="/en/2015/03/15/android-tips-round-up-3/">Android Tips Round-Up, Part 3</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/15</span>
            <a class="archive-post-title" href="/en/2015/03/15/android-tips-round-up-4/">Android Tips Round-Up, Part 4</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/15</span>
            <a class="archive-post-title" href="/en/2015/03/15/android-tips-round-up-5/">Android Tips Round-Up, Part 5</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/04</span>
            <a class="archive-post-title" href="/en/2015/02/04/build-rom-for-nexus5/">Compiling Android Lollipop Firmware for Nexus 5</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span>
            <a class="archive-post-title" href="/en/2015/01/30/android-performance-tools-systrace-1/">Android Performance Optimization - Introduction to Systrace (Part 1)</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/16</span>
            <a class="archive-post-title" href="/en/2015/01/16/view-android-source-code-with-androidstudio/">Viewing Android Lollipop Source Code with Android Studio</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/13</span>
            <a class="archive-post-title" href="/en/2015/01/13/android-performance-optimization-overdraw-2/">Android Performance Optimization: Overdraw - Practical Application</a>
        </li>
                </ul>
            <div class="archive-year"> 2014 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">10/20</span>
            <a class="archive-post-title" href="/en/2014/10/20/android-performance-optimization-overdraw-1/">Android Performance Optimization: Overdraw - Theory</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/03</span>
            <a class="archive-post-title" href="/en/2014/06/03/android-edittext-do-not-auto-get-focus/">Android Tips: How to Prevent EditText from Automatically Getting Focus</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/31</span>
            <a class="archive-post-title" href="/en/2014/05/31/android-tips-round-up-2/">Android Tips Round-Up, Part 2</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/28</span>
            <a class="archive-post-title" href="/en/2014/05/28/android-tips-round-up-1/">Android Tips Round-Up, Part 1</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/02</span>
            <a class="archive-post-title" href="/en/2014/05/02/android_log_to_file/">Android Tools - Log2File</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/25</span>
            <a class="archive-post-title" href="/en/2014/03/25/ubuntu-adb-can-not-find-devices/">Ubuntu: Adb Command Cannot Find Device</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/17</span>
            <a class="archive-post-title" href="/en/2014/03/17/android-build-your-own-android-notification-service-app/">Android Service: Building Your Own Notification Center (1) - Introduction to Accessibility Service</a>
        </li>
            </ul>
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
            <span class="sidebar-tag-name" data-tags="Yearly Recommendations">
                <span class="iconfont-archer">&#xe606;</span>
                Yearly Recommendations
            </span>
            <span class="sidebar-tag-name" data-tags="Startup">
                <span class="iconfont-archer">&#xe606;</span>
                Startup
            </span>
            <span class="sidebar-tag-name" data-tags="Memory">
                <span class="iconfont-archer">&#xe606;</span>
                Memory
            </span>
            <span class="sidebar-tag-name" data-tags="Android">
                <span class="iconfont-archer">&#xe606;</span>
                Android
            </span>
            <span class="sidebar-tag-name" data-tags="Jank">
                <span class="iconfont-archer">&#xe606;</span>
                Jank
            </span>
            <span class="sidebar-tag-name" data-tags="Perfetto">
                <span class="iconfont-archer">&#xe606;</span>
                Perfetto
            </span>
            <span class="sidebar-tag-name" data-tags="Systrace">
                <span class="iconfont-archer">&#xe606;</span>
                Systrace
            </span>
            <span class="sidebar-tag-name" data-tags="Year in Review">
                <span class="iconfont-archer">&#xe606;</span>
                Year in Review
            </span>
            <span class="sidebar-tag-name" data-tags="Knowledge Planet">
                <span class="iconfont-archer">&#xe606;</span>
                Knowledge Planet
            </span>
            <span class="sidebar-tag-name" data-tags="Essays">
                <span class="iconfont-archer">&#xe606;</span>
                Essays
            </span>
            <span class="sidebar-tag-name" data-tags="ANR">
                <span class="iconfont-archer">&#xe606;</span>
                ANR
            </span>
            <span class="sidebar-tag-name" data-tags="Performance">
                <span class="iconfont-archer">&#xe606;</span>
                Performance
            </span>
            <span class="sidebar-tag-name" data-tags="Tools">
                <span class="iconfont-archer">&#xe606;</span>
                Tools
            </span>
            <span class="sidebar-tag-name" data-tags="RenderThread">
                <span class="iconfont-archer">&#xe606;</span>
                RenderThread
            </span>
            <span class="sidebar-tag-name" data-tags="DelayLoad">
                <span class="iconfont-archer">&#xe606;</span>
                DelayLoad
            </span>
            <span class="sidebar-tag-name" data-tags="Java">
                <span class="iconfont-archer">&#xe606;</span>
                Java
            </span>
            <span class="sidebar-tag-name" data-tags="Linux">
                <span class="iconfont-archer">&#xe606;</span>
                Linux
            </span>
            <span class="sidebar-tag-name" data-tags="Framework">
                <span class="iconfont-archer">&#xe606;</span>
                Framework
            </span>
            <span class="sidebar-tag-name" data-tags="Performance Optimization">
                <span class="iconfont-archer">&#xe606;</span>
                Performance Optimization
            </span>
            <span class="sidebar-tag-name" data-tags="Thread Optimization">
                <span class="iconfont-archer">&#xe606;</span>
                Thread Optimization
            </span>
            <span class="sidebar-tag-name" data-tags="Jank Optimization">
                <span class="iconfont-archer">&#xe606;</span>
                Jank Optimization
            </span>
            <span class="sidebar-tag-name" data-tags="Battery Optimization">
                <span class="iconfont-archer">&#xe606;</span>
                Battery Optimization
            </span>
            <span class="sidebar-tag-name" data-tags="ANR Analysis">
                <span class="iconfont-archer">&#xe606;</span>
                ANR Analysis
            </span>
            <span class="sidebar-tag-name" data-tags="Page Response">
                <span class="iconfont-archer">&#xe606;</span>
                Page Response
            </span>
            <span class="sidebar-tag-name" data-tags="Binder">
                <span class="iconfont-archer">&#xe606;</span>
                Binder
            </span>
            <span class="sidebar-tag-name" data-tags="Locking">
                <span class="iconfont-archer">&#xe606;</span>
                Locking
            </span>
            <span class="sidebar-tag-name" data-tags="Scheduling">
                <span class="iconfont-archer">&#xe606;</span>
                Scheduling
            </span>
            <span class="sidebar-tag-name" data-tags="MAT">
                <span class="iconfont-archer">&#xe606;</span>
                MAT
            </span>
            <span class="sidebar-tag-name" data-tags="Compose">
                <span class="iconfont-archer">&#xe606;</span>
                Compose
            </span>
            <span class="sidebar-tag-name" data-tags="Kotlin">
                <span class="iconfont-archer">&#xe606;</span>
                Kotlin
            </span>
            <span class="sidebar-tag-name" data-tags="HashMap">
                <span class="iconfont-archer">&#xe606;</span>
                HashMap
            </span>
            <span class="sidebar-tag-name" data-tags="Programmer">
                <span class="iconfont-archer">&#xe606;</span>
                Programmer
            </span>
            <span class="sidebar-tag-name" data-tags="Annual Recommendations">
                <span class="iconfont-archer">&#xe606;</span>
                Annual Recommendations
            </span>
            <span class="sidebar-tag-name" data-tags="Sharp Tools">
                <span class="iconfont-archer">&#xe606;</span>
                Sharp Tools
            </span>
            <span class="sidebar-tag-name" data-tags="Productivity">
                <span class="iconfont-archer">&#xe606;</span>
                Productivity
            </span>
            <span class="sidebar-tag-name" data-tags="Singleton">
                <span class="iconfont-archer">&#xe606;</span>
                Singleton
            </span>
            <span class="sidebar-tag-name" data-tags="Nexus">
                <span class="iconfont-archer">&#xe606;</span>
                Nexus
            </span>
            <span class="sidebar-tag-name" data-tags="Design Specs">
                <span class="iconfont-archer">&#xe606;</span>
                Design Specs
            </span>
            <span class="sidebar-tag-name" data-tags="Process">
                <span class="iconfont-archer">&#xe606;</span>
                Process
            </span>
            <span class="sidebar-tag-name" data-tags="Stutter">
                <span class="iconfont-archer">&#xe606;</span>
                Stutter
            </span>
            <span class="sidebar-tag-name" data-tags="Overdraw">
                <span class="iconfont-archer">&#xe606;</span>
                Overdraw
            </span>
            <span class="sidebar-tag-name" data-tags="Reading Notes">
                <span class="iconfont-archer">&#xe606;</span>
                Reading Notes
            </span>
            <span class="sidebar-tag-name" data-tags="The Programmer's Apprenticeship">
                <span class="iconfont-archer">&#xe606;</span>
                The Programmer's Apprenticeship
            </span>
            <span class="sidebar-tag-name" data-tags="Design Principles">
                <span class="iconfont-archer">&#xe606;</span>
                Design Principles
            </span>
            <span class="sidebar-tag-name" data-tags="Testing">
                <span class="iconfont-archer">&#xe606;</span>
                Testing
            </span>
            <span class="sidebar-tag-name" data-tags="Internet">
                <span class="iconfont-archer">&#xe606;</span>
                Internet
            </span>
            <span class="sidebar-tag-name" data-tags="Game Programming">
                <span class="iconfont-archer">&#xe606;</span>
                Game Programming
            </span>
            <span class="sidebar-tag-name" data-tags="User Experience">
                <span class="iconfont-archer">&#xe606;</span>
                User Experience
            </span>
            <span class="sidebar-tag-name" data-tags="Liqi">
                <span class="iconfont-archer">&#xe606;</span>
                Liqi
            </span>
            <span class="sidebar-tag-name" data-tags="Community">
                <span class="iconfont-archer">&#xe606;</span>
                Community
            </span>
            <span class="sidebar-tag-name" data-tags="Smooth">
                <span class="iconfont-archer">&#xe606;</span>
                Smooth
            </span>
            <span class="sidebar-tag-name" data-tags="Experience Optimization">
                <span class="iconfont-archer">&#xe606;</span>
                Experience Optimization
            </span>
            <span class="sidebar-tag-name" data-tags="Reading">
                <span class="iconfont-archer">&#xe606;</span>
                Reading
            </span>
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
        <span class="sidebar-category-name" data-categories="Casual Notes">
            <span class="iconfont-archer">&#xe60a;</span>
            Casual Notes
        </span>
        <span class="sidebar-category-name" data-categories="Reading Notes">
            <span class="iconfont-archer">&#xe60a;</span>
            Reading Notes
        </span>
        <span class="sidebar-category-name" data-categories="Essays">
            <span class="iconfont-archer">&#xe60a;</span>
            Essays
        </span>
        <span class="sidebar-category-name" data-categories="Android">
            <span class="iconfont-archer">&#xe60a;</span>
            Android
        </span>
        <span class="sidebar-category-name" data-categories="Java">
            <span class="iconfont-archer">&#xe60a;</span>
            Java
        </span>
        <span class="sidebar-category-name" data-categories="Android Performance Optimization">
            <span class="iconfont-archer">&#xe60a;</span>
            Android Performance Optimization
        </span>
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/en/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "https://androidperformance.com/en",
        root: siteMetaRoot,
        author: "Gracker"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->

        <!-- jquery (must load before main.js) -->
        <script defer src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <!-- main func (depends on jQuery) -->
        <script src="/en/scripts/main.js" defer></script>
        <!-- fancybox -->
        <script>
            (function(){
              var urls = [
                'https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.umd.js',
                'https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.js'
              ];
              function loadNext(){
                var u = urls.shift();
                if(!u) return;
                var s = document.createElement('script');
                s.src = u; s.defer = true;
                s.onload = function(){ if (window.Fancybox) { window.Fancybox.bind('[data-fancybox]'); } };
                s.onerror = loadNext;
                document.head.appendChild(s);
              }
              loadNext();
            })();
        </script>
        <!-- algolia -->
        <!-- busuanzi (delay load + silent fail) -->
        <!-- async load share.js on first click -->
            <script>
                (function(){
                  var loaded = false
                  function loadShare(){
                    if (loaded) return
                    loaded = true
                    var s = document.createElement('script')
                    s.src = '/en/scripts/share.js'
                    s.async = true
                    document.head.appendChild(s)
                  }
                  document.addEventListener('click', function(e){
                    var t = e.target
                    if (!t) return
                    if (t.closest && t.closest('.share-wrapper')) { loadShare() }
                    else if (t.classList && t.classList.contains('share-wrapper')) { loadShare() }
                  }, true)
                })();
            </script>
        <!-- mermaid -->
    </body>
</html>
